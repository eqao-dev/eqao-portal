<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>志望校／併願校管理シート - EQAO PORTAL</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="css/nav-menu.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #e8f0f0 0%, #d4e4e4 100%);
      min-height: 100vh;
      padding-bottom: 40px;
    }

    /* ヘッダー */
    .header {
      background: linear-gradient(135deg, #00695C 0%, #00897B 100%);
      color: white;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 20px rgba(0, 105, 92, 0.4);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .back-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.3s;
    }

    .back-btn:hover { background: rgba(255,255,255,0.25); }

    .header-title { 
      font-size: 17px; 
      font-weight: 700;
      flex: 1;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-user {
      font-size: 12px;
      opacity: 0.9;
    }

    .header-menu-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 16px;
    }

    /* 上部アクションバー */
    .top-action-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
      font-family: inherit;
      border: none;
    }

    .action-btn .material-icons {
      font-size: 20px;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #00695C 0%, #00897B 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 105, 92, 0.3);
    }

    .action-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 105, 92, 0.4);
    }

    .action-btn.secondary {
      background: white;
      color: #00695C;
      border: 2px solid #00695C;
    }

    .action-btn.secondary:hover {
      background: #E0F2F1;
    }

    /* セクション */
    .section {
      background: white;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .section-header {
      background: linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%);
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 2px solid #00695C;
    }

    .section-header .material-icons {
      color: #00695C;
      font-size: 22px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: #004D40;
    }

    .section-content {
      padding: 20px;
    }

    /* ========================================
       パターン選択タブ（上部）
    ======================================== */
    .pattern-tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    @media (max-width: 500px) {
      .pattern-tabs {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .pattern-tab {
      padding: 14px 10px;
      border: 2px solid #E0E0E0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      text-align: center;
      transition: all 0.25s;
    }

    .pattern-tab:hover {
      border-color: #00897B;
      background: #E0F2F1;
    }

    .pattern-tab.active {
      border-color: #00695C;
      background: linear-gradient(135deg, #00695C 0%, #00897B 100%);
      color: white;
      box-shadow: 0 4px 16px rgba(0, 105, 92, 0.35);
    }

    .pattern-tab-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .pattern-tab-letter {
      font-size: 20px;
      font-weight: 700;
    }

    .pattern-tab-name {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      background: rgba(0,0,0,0.08);
    }

    .pattern-tab.active .pattern-tab-name {
      background: rgba(255,255,255,0.25);
    }

    .pattern-tab-icons {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .pattern-tab-icons .item {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .pattern-tab-icons .material-icons {
      font-size: 16px;
    }

    .pattern-tab-icons .ok { color: #4CAF50; }
    .pattern-tab-icons .ng { color: #EF5350; }

    .pattern-tab.active .pattern-tab-icons .ok { color: #A5D6A7; }
    .pattern-tab.active .pattern-tab-icons .ng { color: #FFCDD2; }

    .pattern-tab-count {
      font-size: 13px;
      font-weight: 600;
    }

    .pattern-tab-count-num {
      font-size: 18px;
      font-weight: 700;
    }

    /* パターン内の大学リスト */
    .pattern-school-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 30px;
    }

    .school-card {
      background: #FAFAFA;
      border: 1px solid #E0E0E0;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s;
    }

    .school-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .school-card-header {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      cursor: pointer;
      gap: 14px;
      background: white;
    }

    .school-rank {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #00695C 0%, #00897B 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 13px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .school-main-info {
      flex: 1;
      min-width: 0;
    }

    .school-name {
      font-size: 15px;
      font-weight: 700;
      color: #333;
    }

    .school-faculty {
      font-size: 12px;
      color: #777;
      margin-top: 2px;
    }

    .school-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .school-badge.sengan {
      background: #FFEBEE;
      color: #C62828;
    }

    .school-badge.heigan {
      background: #E3F2FD;
      color: #1565C0;
    }

    .school-expand {
      color: #999;
      transition: transform 0.3s;
    }

    .school-card.open .school-expand {
      transform: rotate(180deg);
    }

    /* 詳細アコーディオン */
    .school-detail {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: #FAFAFA;
    }

    .school-card.open .school-detail {
      max-height: 1000px;
    }

    .school-detail-inner {
      padding: 16px 20px;
      border-top: 1px solid #E0E0E0;
    }

    .detail-section {
      margin-bottom: 16px;
    }

    .detail-section:last-child {
      margin-bottom: 0;
    }

    .detail-section-title {
      font-size: 12px;
      font-weight: 700;
      color: #00695C;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid #E0E0E0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .detail-section-title .material-icons {
      font-size: 16px;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .detail-label {
      font-size: 11px;
      color: #888;
    }

    .detail-value {
      font-size: 13px;
      color: #333;
      font-weight: 500;
    }

    .detail-value.empty {
      color: #bbb;
    }

    /* 空状態 */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state .material-icons {
      font-size: 48px;
      color: #ddd;
      margin-bottom: 12px;
    }

    .empty-state p {
      font-size: 14px;
    }

    /* ========================================
       表示モード切替（下部）
    ======================================== */
    .view-mode-section {
      margin-top: 10px;
    }

    .view-mode-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: #f0f0f0;
      padding: 5px;
      border-radius: 12px;
      width: fit-content;
    }

    .view-mode-btn {
      padding: 10px 18px;
      border: none;
      border-radius: 10px;
      background: transparent;
      color: #666;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      font-family: inherit;
    }

    .view-mode-btn .material-icons {
      font-size: 18px;
    }

    .view-mode-btn:hover {
      background: #e0e0e0;
    }

    .view-mode-btn.active {
      background: white;
      color: #00695C;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* ========================================
       一覧表示モード
    ======================================== */
    .list-view-container {
      display: block;
    }

    .list-view-container.hidden {
      display: none;
    }

    .all-schools-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .list-school-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .list-school-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      gap: 12px;
    }

    .list-pattern-badge {
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      color: white;
      white-space: nowrap;
    }

    .list-pattern-badge.pattern-a { background: #4CAF50; }
    .list-pattern-badge.pattern-b { background: #2196F3; }
    .list-pattern-badge.pattern-c { background: #FF9800; }
    .list-pattern-badge.pattern-d { background: #9E9E9E; }

    .list-school-info {
      flex: 1;
      min-width: 0;
    }

    .list-school-name {
      font-size: 14px;
      font-weight: 700;
      color: #333;
    }

    .list-school-faculty {
      font-size: 12px;
      color: #777;
    }

    .list-school-card.open .school-expand {
      transform: rotate(180deg);
    }

    .list-school-detail {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .list-school-card.open .list-school-detail {
      max-height: 1000px;
    }

    /* ========================================
       全パターン比較モード
    ======================================== */
    .compare-view-container {
      display: none;
    }

    .compare-view-container.show {
      display: block;
    }

    /* パターン選択（横幅均等・丸角四角） */
    .compare-pattern-selector {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    @media (max-width: 600px) {
      .compare-pattern-selector {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .compare-pattern-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border: 2px solid #E0E0E0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      text-align: left;
    }

    .compare-pattern-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #00897B;
    }

    .compare-pattern-btn.active {
      border-width: 2px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .compare-pattern-btn.active.pattern-a { 
      background: linear-gradient(135deg, #E8F5E9, #C8E6C9); 
      border-color: #4CAF50; 
    }
    .compare-pattern-btn.active.pattern-b { 
      background: linear-gradient(135deg, #E3F2FD, #BBDEFB); 
      border-color: #2196F3; 
    }
    .compare-pattern-btn.active.pattern-c { 
      background: linear-gradient(135deg, #FFF3E0, #FFE0B2); 
      border-color: #FF9800; 
    }
    .compare-pattern-btn.active.pattern-d { 
      background: linear-gradient(135deg, #FAFAFA, #EEEEEE); 
      border-color: #9E9E9E; 
    }

    .compare-pattern-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: white;
      flex-shrink: 0;
    }

    .compare-pattern-btn.pattern-a .compare-pattern-icon { background: #4CAF50; }
    .compare-pattern-btn.pattern-b .compare-pattern-icon { background: #2196F3; }
    .compare-pattern-btn.pattern-c .compare-pattern-icon { background: #FF9800; }
    .compare-pattern-btn.pattern-d .compare-pattern-icon { background: #9E9E9E; }

    .compare-pattern-text {
      flex: 1;
      min-width: 0;
    }

    .compare-pattern-label {
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }

    .compare-pattern-count {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    /* 横並び比較カード */
    .compare-cards-wrapper {
      overflow-x: auto;
      padding-bottom: 10px;
      margin: 0 -20px;
      padding-left: 20px;
      padding-right: 20px;
    }

    .compare-cards {
      display: flex;
      gap: 16px;
      min-width: max-content;
    }

    .compare-card {
      width: 280px;
      min-width: 280px;
      background: white;
      border-radius: 14px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      flex-shrink: 0;
    }

    .compare-card-header {
      padding: 16px;
      text-align: center;
      border-bottom: 1px solid #E0E0E0;
    }

    .compare-card-rank {
      font-size: 12px;
      color: #00695C;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .compare-card-name {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-bottom: 4px;
    }

    .compare-card-faculty {
      font-size: 12px;
      color: #777;
      margin-bottom: 8px;
    }

    .compare-card-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .compare-card-badge.sengan {
      background: #FFEBEE;
      color: #C62828;
    }

    .compare-card-badge.heigan {
      background: #E3F2FD;
      color: #1565C0;
    }

    .compare-card-section {
      padding: 14px 16px;
      border-bottom: 1px solid #F0F0F0;
    }

    .compare-card-section:last-child {
      border-bottom: none;
    }

    .compare-card-section-title {
      font-size: 11px;
      font-weight: 700;
      color: #00695C;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .compare-card-section-title .material-icons {
      font-size: 14px;
    }

    .compare-card-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .compare-card-item:last-child {
      margin-bottom: 0;
    }

    .compare-card-item-label {
      color: #888;
      flex-shrink: 0;
      margin-right: 8px;
    }

    .compare-card-item-value {
      color: #333;
      font-weight: 500;
      text-align: right;
    }

    .compare-card-item-value.empty {
      color: #ccc;
    }

    .compare-empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .compare-empty-state .material-icons {
      font-size: 48px;
      color: #ddd;
      margin-bottom: 12px;
    }

    /* 受験スケジュールへのリンク */
    .link-to-schedule {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      background: linear-gradient(135deg, #00695C 0%, #00897B 100%);
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 20px;
      transition: all 0.2s;
    }

    .link-to-schedule:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 105, 92, 0.35);
    }

    .link-to-schedule .material-icons {
      font-size: 20px;
    }

    /* ローディング */
    .loading-state {
      text-align: center;
      padding: 60px 20px;
    }

    .loading-state .material-icons {
      font-size: 48px;
      color: #00695C;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    .loading-state p {
      margin-top: 16px;
      font-size: 14px;
      color: #666;
    }

    /* スクロールヒント */
    .scroll-hint {
      text-align: center;
      font-size: 12px;
      color: #999;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .scroll-hint .material-icons {
      font-size: 16px;
    }

    /* ========================================
       倍率目安ポップアップ
    ======================================== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 18px 20px;
      border-bottom: 1px solid #E0E0E0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%);
    }

    .modal-title {
      font-size: 16px;
      font-weight: 700;
      color: #00695C;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-title .material-icons {
      font-size: 22px;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.15);
    }

    .modal-body {
      padding: 20px;
    }

    .ratio-guide-intro {
      font-size: 13px;
      color: #666;
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .ratio-item {
      display: flex;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 10px;
      margin-bottom: 10px;
      align-items: flex-start;
    }

    .ratio-item:last-child {
      margin-bottom: 0;
    }

    .ratio-item.danger { background: #FFEBEE; }
    .ratio-item.warning { background: #FFF3E0; }
    .ratio-item.caution { background: #FFFDE7; }
    .ratio-item.normal { background: #E8F5E9; }
    .ratio-item.safe { background: #E0F7FA; }

    .ratio-badge {
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .ratio-item.danger .ratio-badge { background: #C62828; color: white; }
    .ratio-item.warning .ratio-badge { background: #EF6C00; color: white; }
    .ratio-item.caution .ratio-badge { background: #F9A825; color: white; }
    .ratio-item.normal .ratio-badge { background: #2E7D32; color: white; }
    .ratio-item.safe .ratio-badge { background: #00838F; color: white; }

    .ratio-desc {
      font-size: 13px;
      color: #333;
      line-height: 1.5;
    }
    /* ========================================
       スマホ向けコンパクト表示
    ======================================== */
    @media (max-width: 600px) {
      .container {
        padding: 12px 12px;
      }

      /* 上部アクションバー - コンパクトに */
      .top-action-bar {
        gap: 8px;
        margin-bottom: 14px;
      }

      .action-btn {
        padding: 8px 12px;
        font-size: 12px;
        border-radius: 8px;
        gap: 5px;
      }

      .action-btn .material-icons {
        font-size: 16px;
      }

      /* セクション - コンパクトに */
      .section {
        border-radius: 12px;
        margin-bottom: 14px;
      }

      .section-header {
        padding: 10px 14px;
        gap: 8px;
      }

      .section-header .material-icons {
        font-size: 18px;
      }

      .section-title {
        font-size: 14px;
      }

      .section-content {
        padding: 12px;
      }

      /* パターンタブ - コンパクトに */
      .pattern-tabs {
        gap: 6px;
        margin-bottom: 14px;
      }

      .pattern-tab {
        padding: 8px 6px;
        border-radius: 8px;
        border-width: 1.5px;
      }

      .pattern-tab-header {
        gap: 4px;
        margin-bottom: 4px;
      }

      .pattern-tab-letter {
        font-size: 16px;
      }

      .pattern-tab-name {
        font-size: 9px;
        padding: 1px 5px;
      }

      .pattern-tab-icons {
        gap: 4px;
        margin-bottom: 4px;
        font-size: 10px;
      }

      .pattern-tab-icons .material-icons {
        font-size: 12px;
      }

      .pattern-tab-count {
        font-size: 11px;
      }

      .pattern-tab-count-num {
        font-size: 14px;
      }

      /* 学校カード - コンパクトに */
      .pattern-school-list {
        gap: 8px;
        margin-bottom: 20px;
      }

      .school-card {
        border-radius: 10px;
      }

      .school-card-header {
        padding: 10px 12px;
        gap: 10px;
      }

      .school-rank {
        width: 26px;
        height: 26px;
        font-size: 11px;
      }

      .school-name {
        font-size: 13px;
      }

      .school-faculty {
        font-size: 11px;
      }

      .school-badge {
        padding: 2px 6px;
        font-size: 9px;
      }

      .school-detail-inner {
        padding: 12px 14px;
      }

      .detail-section {
        margin-bottom: 12px;
      }

      .detail-section-title {
        font-size: 11px;
        margin-bottom: 8px;
        padding-bottom: 4px;
      }

      .detail-section-title .material-icons {
        font-size: 14px;
      }

      .detail-grid {
        gap: 8px;
      }

      .detail-label {
        font-size: 10px;
      }

      .detail-value {
        font-size: 12px;
      }

      /* 表示モード切替 - コンパクトに */
      .view-mode-toggle {
        margin-bottom: 14px;
        padding: 3px;
        border-radius: 8px;
      }

      .view-mode-btn {
        padding: 6px 10px;
        font-size: 11px;
        gap: 4px;
        border-radius: 6px;
      }

      .view-mode-btn .material-icons {
        font-size: 14px;
      }

      /* 一覧表示 - コンパクトに */
      .all-schools-list {
        gap: 8px;
      }

      .list-school-card {
        border-radius: 10px;
      }

      .list-school-header {
        padding: 10px 12px;
        gap: 8px;
      }

      .list-pattern-badge {
        padding: 3px 6px;
        font-size: 9px;
        border-radius: 5px;
      }

      .list-school-name {
        font-size: 13px;
      }

      .list-school-faculty {
        font-size: 11px;
      }

      /* 全パターン比較 - コンパクトに */
      .compare-pattern-selector {
        gap: 6px;
        margin-bottom: 14px;
      }

      .compare-pattern-btn {
        padding: 8px 10px;
        gap: 8px;
        border-radius: 8px;
      }

      .compare-pattern-icon {
        width: 28px;
        height: 28px;
        font-size: 13px;
      }

      .compare-pattern-label {
        font-size: 11px;
      }

      .compare-pattern-count {
        font-size: 10px;
      }

      /* 比較カード - コンパクトに */
      .compare-cards-wrapper {
        margin: 0 -12px;
        padding-left: 12px;
        padding-right: 12px;
      }

      .compare-cards {
        gap: 10px;
      }

      .compare-card {
        width: 220px;
        min-width: 220px;
        border-radius: 10px;
      }

      .compare-card-header {
        padding: 12px;
      }

      .compare-card-rank {
        font-size: 10px;
        margin-bottom: 4px;
      }

      .compare-card-name {
        font-size: 13px;
        margin-bottom: 2px;
      }

      .compare-card-faculty {
        font-size: 10px;
        margin-bottom: 6px;
      }

      .compare-card-badge {
        padding: 2px 8px;
        font-size: 9px;
      }

      .compare-card-section {
        padding: 10px 12px;
      }

      .compare-card-section-title {
        font-size: 10px;
        margin-bottom: 6px;
      }

      .compare-card-section-title .material-icons {
        font-size: 12px;
      }

      .compare-card-item {
        margin-bottom: 5px;
        font-size: 10px;
      }

      /* 下部リンク - コンパクトに */
      .link-to-schedule {
        padding: 10px 14px;
        font-size: 12px;
        border-radius: 8px;
        margin-top: 14px;
        gap: 6px;
      }

      .link-to-schedule .material-icons {
        font-size: 16px;
      }

      /* 空状態 - コンパクトに */
      .empty-state {
        padding: 30px 16px;
      }

      .empty-state .material-icons {
        font-size: 40px;
        margin-bottom: 8px;
      }

      .empty-state p {
        font-size: 12px;
      }

      /* モーダル - コンパクトに */
      .modal-overlay {
        padding: 12px;
      }

      .modal-header {
        padding: 12px 14px;
      }

      .modal-title {
        font-size: 14px;
      }

      .modal-title .material-icons {
        font-size: 18px;
      }

      .modal-close {
        width: 30px;
        height: 30px;
      }

      .modal-body {
        padding: 14px;
      }

      .ratio-guide-intro {
        font-size: 12px;
        margin-bottom: 12px;
      }

      .ratio-item {
        padding: 10px 12px;
        margin-bottom: 8px;
        gap: 10px;
      }

      .ratio-badge {
        padding: 4px 8px;
        font-size: 10px;
      }

      .ratio-desc {
        font-size: 11px;
      }

      /* スクロールヒント */
      .scroll-hint {
        font-size: 10px;
        margin-top: 8px;
      }

      .scroll-hint .material-icons {
        font-size: 14px;
      }
    }

    /* ========================================
       穴場情報モーダル
    ======================================== */
    .anaba-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .anaba-modal-overlay.show {
      display: flex;
    }

    .anaba-modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: anabaSlideIn 0.3s ease;
    }

    @keyframes anabaSlideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .anaba-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #E0E0E0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%);
      border-radius: 16px 16px 0 0;
    }

    .anaba-modal-title {
      font-size: 16px;
      font-weight: 700;
      color: #00695C;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .anaba-modal-close {
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      transition: all 0.2s;
    }

    .anaba-modal-close:hover {
      background: rgba(0, 0, 0, 0.15);
    }

    .anaba-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }

    /* カテゴリタブ */
    .anaba-tabs {
      display: flex;
      border-bottom: 2px solid #E0E0E0;
      background: #FAFAFA;
      overflow-x: auto;
    }

    .anaba-tab {
      flex: 1;
      min-width: 80px;
      padding: 12px 8px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .anaba-tab:hover {
      background: #E0F2F1;
    }

    .anaba-tab.active {
      color: #00695C;
      border-bottom-color: #00695C;
      background: white;
    }

    .anaba-tab-icon {
      font-size: 22px;
      display: block;
      margin-bottom: 4px;
      color: #666;
    }

    .anaba-tab.active .anaba-tab-icon {
      color: #00695C;
    }

    /* ========================================
       報告ボタン（書類・一次・二次）
    ======================================== */
    .report-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #E0E0E0;
    }

    .report-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      flex: 1;
    }

    .report-btn .material-icons {
      font-size: 18px;
    }

    .report-btn.doc-btn {
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      color: #1565C0;
      border: 1px solid #90CAF9;
    }

    .report-btn.doc-btn:hover {
      background: linear-gradient(135deg, #BBDEFB 0%, #90CAF9 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(21, 101, 192, 0.2);
    }

    .report-btn.doc-btn .count {
      background: #1565C0;
      color: white;
      padding: 2px 7px;
      border-radius: 10px;
      font-size: 11px;
      margin-left: 4px;
    }

    .report-btn.result-btn {
      background: #F5F5F5;
      color: #BDBDBD;
      cursor: not-allowed;
      border: 1px solid #E0E0E0;
    }

    .report-btn.result-btn.active {
      background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
      color: #2E7D32;
      border: 1px solid #A5D6A7;
      cursor: pointer;
    }

    .report-btn.result-btn.active:hover {
      background: linear-gradient(135deg, #C8E6C9 0%, #A5D6A7 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(46, 125, 50, 0.2);
    }

    .report-btn.result-btn.reported {
      background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
      color: #2E7D32;
      border: 1px solid #A5D6A7;
    }

    .report-btn.result-btn.reported .material-icons {
      color: #2E7D32;
    }

    /* 書類ステータスバッジ（SNS通知風） */
    .doc-status-icon {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      flex-shrink: 0;
    }

    .doc-status-icon .material-icons {
      font-size: 24px;
      color: #78909C;
    }

    .doc-status-icon.has-docs .material-icons {
      color: #1565C0;
    }

    .doc-status-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      border-radius: 9px;
      font-size: 11px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .doc-status-badge.count-zero {
      background: #E53935;
      animation: pulseRed 2s ease-in-out infinite;
    }

    .doc-status-badge.count-positive {
      background: #43A047;
    }

    @keyframes pulseRed {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* 書類バッジ凡例 */
    .doc-badge-legend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 8px 12px;
      margin-bottom: 12px;
      background: #F5F5F5;
      border-radius: 8px;
      font-size: 11px;
      color: #666;
    }

    .doc-badge-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .doc-badge-legend .legend-icon {
      position: relative;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .doc-badge-legend .legend-icon .material-icons {
      font-size: 18px;
      color: #78909C;
    }

    .doc-badge-legend .legend-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 14px;
      height: 14px;
      border-radius: 7px;
      font-size: 9px;
      font-weight: 700;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .doc-badge-legend .legend-badge.red {
      background: #E53935;
    }

    .doc-badge-legend .legend-badge.green {
      background: #43A047;
    }

    @media (max-width: 600px) {
      .doc-badge-legend {
        flex-direction: column;
        gap: 6px;
        padding: 10px;
      }
    }

    /* ========================================
       書類提出モーダル
    ======================================== */
    .doc-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .doc-modal-overlay.show {
      display: flex;
    }

    .doc-modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: docSlideIn 0.3s ease;
    }

    @keyframes docSlideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .doc-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #E0E0E0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      border-radius: 16px 16px 0 0;
    }

    .doc-modal-title {
      font-size: 15px;
      font-weight: 700;
      color: #1565C0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .doc-modal-title .material-icons {
      font-size: 22px;
    }

    .doc-modal-univ {
      font-size: 12px;
      color: #1976D2;
      margin-top: 4px;
    }

    .doc-modal-close {
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      transition: all 0.2s;
    }

    .doc-modal-close:hover {
      background: rgba(0, 0, 0, 0.15);
    }

    .doc-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .doc-form-group {
      margin-bottom: 16px;
    }

    .doc-form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
    }

    .doc-form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #DDD;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }

    .doc-form-input:focus {
      outline: none;
      border-color: #1565C0;
      box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1);
    }

    .doc-input-type {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }

    .doc-input-type label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    .doc-form-textarea {
      width: 100%;
      min-height: 150px;
      padding: 12px;
      border: 1px solid #DDD;
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
    }

    .doc-form-textarea:focus {
      outline: none;
      border-color: #1565C0;
      box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1);
    }

    .doc-file-input-wrapper {
      position: relative;
      display: none;
    }

    .doc-file-input-wrapper.show {
      display: block;
    }

    .doc-file-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 20px;
      border: 2px dashed #BBDEFB;
      border-radius: 8px;
      background: #F5F9FF;
      cursor: pointer;
      transition: all 0.2s;
    }

    .doc-file-label:hover {
      border-color: #1565C0;
      background: #E3F2FD;
    }

    .doc-file-label .material-icons {
      font-size: 28px;
      color: #1565C0;
    }

    .doc-file-label span {
      font-size: 13px;
      color: #1565C0;
    }

    .doc-file-input {
      display: none;
    }

    .doc-file-selected {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #E3F2FD;
      border-radius: 8px;
      margin-top: 8px;
    }

    .doc-file-selected.show {
      display: flex;
    }

    .doc-file-selected .file-name {
      flex: 1;
      font-size: 12px;
      color: #1565C0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .doc-file-selected .remove-file {
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
      padding: 2px;
    }

    .doc-text-wrapper {
      display: none;
    }

    .doc-text-wrapper.show {
      display: block;
    }

    .doc-submit-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #1565C0 0%, #1976D2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .doc-submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3);
    }

    .doc-submit-btn:disabled {
      background: #BDBDBD;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* 履歴セクション */
    .doc-history-section {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #E0E0E0;
    }

    .doc-history-title {
      font-size: 13px;
      font-weight: 700;
      color: #333;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }

    .doc-history-title .material-icons {
      font-size: 18px;
      color: #1565C0;
    }

    .doc-history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .doc-history-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      background: #FAFAFA;
      border-radius: 8px;
      border: 1px solid #EEE;
    }

    .doc-history-item-info {
      flex: 1;
    }

    .doc-history-item-type {
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }

    .doc-history-item-date {
      font-size: 11px;
      color: #999;
      margin-top: 2px;
    }

    .doc-history-item-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 8px;
    }

    .doc-history-item-badge.text {
      background: #E8F5E9;
      color: #2E7D32;
    }

    .doc-history-item-badge.file {
      background: #E3F2FD;
      color: #1565C0;
    }

    .doc-history-view-btn {
      padding: 6px 12px;
      background: white;
      border: 1px solid #1565C0;
      color: #1565C0;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .doc-history-view-btn:hover {
      background: #E3F2FD;
    }

    .doc-history-empty {
      text-align: center;
      padding: 20px;
      color: #999;
      font-size: 13px;
    }

    /* 内容表示モーダル */
    .doc-content-modal {
      max-width: 700px;
    }

    .doc-content-body {
      padding: 20px;
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.7;
      color: #333;
      background: #FAFAFA;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
    }

    .doc-content-file-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: #E3F2FD;
      border-radius: 8px;
      color: #1565C0;
      text-decoration: none;
      font-weight: 600;
    }

    .doc-content-file-link:hover {
      background: #BBDEFB;
    }

    /* モバイル対応 */
    @media (max-width: 600px) {
      .report-buttons {
        flex-direction: column;
        gap: 6px;
      }

      .report-btn {
        padding: 10px 12px;
        font-size: 12px;
      }

      .report-btn .material-icons {
        font-size: 16px;
      }

      .doc-modal {
        max-height: 95vh;
      }

      .doc-modal-header {
        padding: 14px 16px;
      }

      .doc-modal-body {
        padding: 16px;
      }
    }

    /* 注意喚起エリア */
    .anaba-caution {
      background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
      padding: 14px 16px;
      border-left: 4px solid #FF9800;
      margin: 16px;
      border-radius: 8px;
    }

    .anaba-caution-title {
      font-size: 13px;
      font-weight: 700;
      color: #E65100;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }

    .anaba-caution-text {
      font-size: 12px;
      color: #5D4037;
      line-height: 1.6;
    }

    .anaba-caution-detail {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #FFCC80;
      font-size: 11px;
      line-height: 1.6;
      color: #5D4037;
    }

    .anaba-caution-detail.show {
      display: block;
    }

    .anaba-caution-toggle {
      font-size: 11px;
      color: #FF6F00;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
    }

    .anaba-caution-toggle:hover {
      text-decoration: underline;
    }

    /* フィルタエリア */
    .anaba-filters {
      padding: 12px 16px;
      background: #F5F5F5;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .anaba-filter-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .anaba-filter-label {
      font-size: 11px;
      color: #666;
      font-weight: 600;
    }

    .anaba-filter-select {
      padding: 6px 10px;
      border: 1px solid #DDD;
      border-radius: 6px;
      font-size: 12px;
      background: white;
      cursor: pointer;
    }

    .anaba-filter-select:focus {
      outline: none;
      border-color: #00695C;
    }

    .anaba-result-count {
      font-size: 12px;
      color: #666;
      margin-left: auto;
    }

    /* データリスト */
    .anaba-list {
      padding: 16px;
    }

    .anaba-item {
      background: white;
      border: 1px solid #E0E0E0;
      border-radius: 10px;
      margin-bottom: 12px;
      overflow: hidden;
      transition: all 0.2s;
    }

    .anaba-item:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .anaba-item-header {
      padding: 12px 14px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      cursor: pointer;
    }

    .anaba-item-main {
      flex: 1;
    }

    .anaba-item-univ {
      font-size: 14px;
      font-weight: 700;
      color: #00695C;
      margin-bottom: 2px;
    }

    .anaba-item-faculty {
      font-size: 12px;
      color: #333;
    }

    .anaba-item-badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .anaba-badge {
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
    }

    .anaba-badge.hyotei {
      background: #E3F2FD;
      color: #1565C0;
    }

    .anaba-badge.eiken {
      background: #F3E5F5;
      color: #7B1FA2;
    }

    .anaba-badge.heigan {
      background: #E8F5E9;
      color: #2E7D32;
    }

    .anaba-badge.sengan {
      background: #FFEBEE;
      color: #C62828;
    }

    .anaba-badge.ratio {
      background: #FFF8E1;
      color: #F57F17;
    }

    .anaba-item-area {
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
      background: #ECEFF1;
      color: #546E7A;
    }

    .anaba-item-detail {
      display: none;
      padding: 0 14px 14px;
      border-top: 1px dashed #E0E0E0;
    }

    .anaba-item-detail.show {
      display: block;
    }

    .anaba-item-point {
      font-size: 12px;
      color: #555;
      line-height: 1.6;
      margin-top: 10px;
      padding: 10px;
      background: #FAFAFA;
      border-radius: 6px;
    }

    .anaba-item-expand {
      color: #00695C;
      font-size: 20px;
      transition: transform 0.2s;
    }

    .anaba-item-expand.open {
      transform: rotate(180deg);
    }

    /* 空の状態 */
    .anaba-empty {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .anaba-empty .material-icons {
      font-size: 48px;
      margin-bottom: 12px;
    }

    /* ローディング */
    .anaba-loading {
      text-align: center;
      padding: 40px 20px;
    }

    .anaba-loading .material-icons {
      font-size: 36px;
      color: #00695C;
      animation: spin 1s linear infinite;
    }

    /* モバイル対応 */
    @media (max-width: 600px) {
      .anaba-modal {
        max-height: 95vh;
        border-radius: 12px;
      }

      .anaba-tab {
        padding: 10px 6px;
        font-size: 11px;
      }

      .anaba-tab-icon {
        font-size: 18px;
      }

      .anaba-filters {
        flex-direction: column;
        align-items: stretch;
      }

      .anaba-filter-group {
        justify-content: space-between;
      }

      .anaba-result-count {
        margin-left: 0;
        text-align: right;
      }

      .anaba-item-header {
        padding: 10px 12px;
      }

      .anaba-item-univ {
        font-size: 13px;
      }

      .anaba-item-faculty {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="index.html" class="back-btn">
      <span class="material-icons">arrow_back</span>
    </a>
    <span class="header-title">志望校／併願校管理シート</span>
    <div class="header-right">
      <span class="header-user" id="userName">---</span>
      <button class="header-menu-btn" onclick="openNav()">
        <span class="material-icons">menu</span>
      </button>
    </div>
  </div>

  <div class="container">
    <!-- 上部アクションバー -->
    <div class="top-action-bar">
      <a href="exam-schedule.html" class="action-btn primary">
        <span class="material-icons">edit_calendar</span>
        志望校を編集する
      </a>
      <button class="action-btn secondary" onclick="openAnabaModal()">
        <span class="material-icons">lightbulb</span>
        穴場情報
      </button>
      <button class="action-btn secondary" onclick="openRatioGuide()">
        <span class="material-icons">info</span>
        倍率の目安
      </button>
    </div>

    <!-- ========================================
         上部：パターン選択 + 選択パターンの大学一覧
    ======================================== -->
    <div class="section">
      <div class="section-header">
        <span class="material-icons">category</span>
        <span class="section-title">パターン別 志望校</span>
      </div>
      <div class="section-content">
        
        <!-- パターン選択タブ -->
        <div class="pattern-tabs" id="patternTabs">
          <div class="pattern-tab active" data-pattern="A" onclick="selectPattern('A')">
            <div class="pattern-tab-header">
              <div class="pattern-tab-letter">A</div>
              <div class="pattern-tab-name">ベスト</div>
            </div>
            <div class="pattern-tab-icons">
              <span class="item"><span class="material-icons ok">check_circle</span>評定</span>
              <span class="item"><span class="material-icons ok">check_circle</span>英語</span>
            </div>
            <div class="pattern-tab-count"><span class="pattern-tab-count-num" id="tabCountA">0</span>校</div>
          </div>
          <div class="pattern-tab" data-pattern="B" onclick="selectPattern('B')">
            <div class="pattern-tab-header">
              <div class="pattern-tab-letter">B</div>
              <div class="pattern-tab-name">評定のみ</div>
            </div>
            <div class="pattern-tab-icons">
              <span class="item"><span class="material-icons ok">check_circle</span>評定</span>
              <span class="item"><span class="material-icons ng">cancel</span>英語</span>
            </div>
            <div class="pattern-tab-count"><span class="pattern-tab-count-num" id="tabCountB">0</span>校</div>
          </div>
          <div class="pattern-tab" data-pattern="C" onclick="selectPattern('C')">
            <div class="pattern-tab-header">
              <div class="pattern-tab-letter">C</div>
              <div class="pattern-tab-name">英語のみ</div>
            </div>
            <div class="pattern-tab-icons">
              <span class="item"><span class="material-icons ng">cancel</span>評定</span>
              <span class="item"><span class="material-icons ok">check_circle</span>英語</span>
            </div>
            <div class="pattern-tab-count"><span class="pattern-tab-count-num" id="tabCountC">0</span>校</div>
          </div>
          <div class="pattern-tab" data-pattern="D" onclick="selectPattern('D')">
            <div class="pattern-tab-header">
              <div class="pattern-tab-letter">D</div>
              <div class="pattern-tab-name">セーフティ</div>
            </div>
            <div class="pattern-tab-icons">
              <span class="item"><span class="material-icons ng">cancel</span>評定</span>
              <span class="item"><span class="material-icons ng">cancel</span>英語</span>
            </div>
            <div class="pattern-tab-count"><span class="pattern-tab-count-num" id="tabCountD">0</span>校</div>
          </div>
        </div>

        <!-- 書類バッジ凡例 -->
        <div class="doc-badge-legend">
          <span>📄 の数字＝提出済み書類数</span>
          <div class="doc-badge-legend-item">
            <div class="legend-icon">
              <span class="material-icons">description</span>
              <span class="legend-badge red">0</span>
            </div>
            <span>未提出</span>
          </div>
          <div class="doc-badge-legend-item">
            <div class="legend-icon">
              <span class="material-icons">description</span>
              <span class="legend-badge green">3</span>
            </div>
            <span>3件提出済</span>
          </div>
        </div>

        <!-- 選択パターンの大学リスト -->
        <div id="patternSchoolList">
          <div class="loading-state" id="loadingState">
            <span class="material-icons">sync</span>
            <p>データを読み込み中...</p>
          </div>
          <div class="pattern-school-list" id="patternSchools" style="display:none;"></div>
          <div class="empty-state" id="patternEmpty" style="display:none;">
            <span class="material-icons">school</span>
            <p>このパターンには志望校が登録されていません</p>
          </div>
        </div>

      </div>
    </div>

    <!-- ========================================
         下部：表示モード切替 + 一覧/比較
    ======================================== -->
    <div class="section">
      <div class="section-header">
        <span class="material-icons">compare_arrows</span>
        <span class="section-title">全体表示・比較</span>
      </div>
      <div class="section-content view-mode-section">
        
        <!-- 表示モード切替 -->
        <div class="view-mode-toggle">
          <button class="view-mode-btn active" data-mode="list" onclick="setViewMode('list')">
            <span class="material-icons">list</span>
            一覧表示
          </button>
          <button class="view-mode-btn" data-mode="compare" onclick="setViewMode('compare')">
            <span class="material-icons">view_column</span>
            全パターン比較
          </button>
        </div>

        <!-- 書類バッジ凡例 -->
        <div class="doc-badge-legend">
          <span>📄 の数字＝提出済み書類数</span>
          <div class="doc-badge-legend-item">
            <div class="legend-icon">
              <span class="material-icons">description</span>
              <span class="legend-badge red">0</span>
            </div>
            <span>未提出</span>
          </div>
          <div class="doc-badge-legend-item">
            <div class="legend-icon">
              <span class="material-icons">description</span>
              <span class="legend-badge green">3</span>
            </div>
            <span>3件提出済</span>
          </div>
        </div>

        <!-- 一覧表示 -->
        <div class="list-view-container" id="listView">
          <div class="all-schools-list" id="allSchoolsList"></div>
          <div class="empty-state" id="listEmpty" style="display:none;">
            <span class="material-icons">school</span>
            <p>登録されている志望校はありません</p>
          </div>
        </div>

        <!-- 全パターン比較 -->
        <div class="compare-view-container" id="compareView">
          <!-- パターン選択 -->
          <div class="compare-pattern-selector">
            <button class="compare-pattern-btn pattern-a active" data-pattern="A" onclick="selectComparePattern('A')">
              <div class="compare-pattern-icon">A</div>
              <div class="compare-pattern-text">
                <div class="compare-pattern-label">ベストケース</div>
                <div class="compare-pattern-count" id="compareCountA">0校</div>
              </div>
            </button>
            <button class="compare-pattern-btn pattern-b" data-pattern="B" onclick="selectComparePattern('B')">
              <div class="compare-pattern-icon">B</div>
              <div class="compare-pattern-text">
                <div class="compare-pattern-label">評定のみ</div>
                <div class="compare-pattern-count" id="compareCountB">0校</div>
              </div>
            </button>
            <button class="compare-pattern-btn pattern-c" data-pattern="C" onclick="selectComparePattern('C')">
              <div class="compare-pattern-icon">C</div>
              <div class="compare-pattern-text">
                <div class="compare-pattern-label">英語のみ</div>
                <div class="compare-pattern-count" id="compareCountC">0校</div>
              </div>
            </button>
            <button class="compare-pattern-btn pattern-d" data-pattern="D" onclick="selectComparePattern('D')">
              <div class="compare-pattern-icon">D</div>
              <div class="compare-pattern-text">
                <div class="compare-pattern-label">セーフティ</div>
                <div class="compare-pattern-count" id="compareCountD">0校</div>
              </div>
            </button>
          </div>

          <!-- 横並び比較カード -->
          <div class="compare-cards-wrapper">
            <div class="compare-cards" id="compareCards"></div>
          </div>
          <div class="scroll-hint" id="scrollHint" style="display:none;">
            <span class="material-icons">swipe</span>
            横にスクロールして比較できます
          </div>
          <div class="compare-empty-state" id="compareEmpty" style="display:none;">
            <span class="material-icons">school</span>
            <p>このパターンには志望校が登録されていません</p>
          </div>
        </div>

        <!-- 受験スケジュールへのリンク -->
        <a href="exam-schedule.html" class="link-to-schedule">
          <span class="material-icons">edit_calendar</span>
          受験スケジュールページで志望校を編集する
        </a>

      </div>
    </div>
  </div>

  <!-- 倍率目安ポップアップ -->
  <div class="modal-overlay" id="ratioGuideModal" onclick="closeRatioGuide(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <span class="material-icons">analytics</span>
          倍率の目安（基準）
        </div>
        <button class="modal-close" onclick="closeRatioGuide()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <p class="ratio-guide-intro">
          総合型選抜における倍率の目安です。志望校選びの参考にしてください。
        </p>
        
        <div class="ratio-item danger">
          <span class="ratio-badge">8倍以上</span>
          <span class="ratio-desc">極めて厳しい。出願には慎重な検討が必要。</span>
        </div>
        
        <div class="ratio-item danger">
          <span class="ratio-badge">7倍台</span>
          <span class="ratio-desc">危険ゾーン。戦略的に挑むなら強い準備が必須。</span>
        </div>
        
        <div class="ratio-item warning">
          <span class="ratio-badge">6倍台</span>
          <span class="ratio-desc">とても難易度が高い。強みや独自性がないと突破は困難。</span>
        </div>
        
        <div class="ratio-item warning">
          <span class="ratio-badge">5倍台</span>
          <span class="ratio-desc">難易度はかなり高め。入念な対策を要する。</span>
        </div>
        
        <div class="ratio-item caution">
          <span class="ratio-badge">4倍台</span>
          <span class="ratio-desc">チャレンジ校認定スタート基準。対策次第で合否が分かれる。</span>
        </div>
        
        <div class="ratio-item caution">
          <span class="ratio-badge">3倍台</span>
          <span class="ratio-desc">簡単ではない。油断すれば落ちるレベル。</span>
        </div>
        
        <div class="ratio-item normal">
          <span class="ratio-badge">2倍台</span>
          <span class="ratio-desc">合格可能性は高いが、気を抜かずに対策を。</span>
        </div>
        
        <div class="ratio-item safe">
          <span class="ratio-badge">1倍台</span>
          <span class="ratio-desc">穴場。出願条件を満たせば合格率は比較的高い。</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // API設定
    // ============================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbyXdCxzPU6oXAm2Mi9mfMDeNvQAyE0mmTOABA2EOYelvX6J2Rr48VcizS0vMgIS7Qc7/exec';

    // ============================================
    // 状態管理
    // ============================================
    let schoolPatterns = { A: [], B: [], C: [], D: [] };
    let selectedPattern = 'A';
    let selectedComparePattern = 'A';
    let currentViewMode = 'list';

    const patternNames = {
      A: 'ベストケース',
      B: '評定のみ',
      C: '英語のみ',
      D: 'セーフティ'
    };

    // ============================================
    // 初期化
    // ============================================
    document.addEventListener('DOMContentLoaded', async () => {
      const studentId = localStorage.getItem('eqao_studentId');
      const studentName = localStorage.getItem('eqao_studentName');
      
      if (!studentId) {
        localStorage.setItem('eqao_returnUrl', window.location.href);
        window.location.href = 'login.html';
        return;
      }
      
      document.getElementById('userName').textContent = studentName || studentId;
      await loadSchoolData(studentId);
    });

    // ============================================
    // データ読み込み
    // ============================================
    async function loadSchoolData(studentId) {
      try {
        const url = `${API_URL}?action=getSchoolData&studentId=${studentId}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data && typeof data === 'object') {
          if (data.A || data.B || data.C || data.D) {
            schoolPatterns = {
              A: data.A || [],
              B: data.B || [],
              C: data.C || [],
              D: data.D || []
            };
          } else if (Array.isArray(data)) {
            schoolPatterns = { A: data, B: [], C: [], D: [] };
          }
        }
        
        document.getElementById('loadingState').style.display = 'none';
        updateAllCounts();
        renderPatternSchools();
        renderAllSchoolsList();
        renderCompareCards();
        
      } catch (error) {
        console.error('API error:', error);
        document.getElementById('loadingState').innerHTML = `
          <span class="material-icons" style="animation:none; color:#ccc;">cloud_off</span>
          <p>データの読み込みに失敗しました</p>
        `;
      }
    }

    // ============================================
    // カウント更新
    // ============================================
    function updateAllCounts() {
      ['A', 'B', 'C', 'D'].forEach(p => {
        const schools = schoolPatterns[p] || [];
        const count = schools.length;
        
        document.getElementById(`tabCount${p}`).textContent = count;
        document.getElementById(`compareCount${p}`).textContent = `${count}校`;
      });
    }

    // ============================================
    // パターン選択（上部）
    // ============================================
    function selectPattern(pattern) {
      selectedPattern = pattern;
      document.querySelectorAll('.pattern-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.pattern === pattern);
      });
      renderPatternSchools();
    }

    // ============================================
    // パターン内の大学リスト描画
    // ============================================
    function renderPatternSchools() {
      const container = document.getElementById('patternSchools');
      const emptyState = document.getElementById('patternEmpty');
      const schools = schoolPatterns[selectedPattern] || [];
      
      if (schools.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }
      
      container.style.display = 'flex';
      emptyState.style.display = 'none';
      
      container.innerHTML = schools.map((school, index) => renderSchoolCard(school, index, `pattern-${index}`)).join('');
    }

    // ============================================
    // 学校カード生成（詳細アコーディオン付き）
    // ============================================
    function renderSchoolCard(school, rank, idPrefix) {
      const typeClass = school.applicationType === '専願' ? 'sengan' : (school.applicationType === '併願' ? 'heigan' : '');
      const cardId = `${idPrefix}`;
      const univKey = `${school.universityName}|${school.faculty}`;
      const docCount = documentSummary[univKey] || 0;
      
      // SNS通知風バッジ
      const badgeClass = docCount > 0 ? 'count-positive' : 'count-zero';
      const iconClass = docCount > 0 ? 'has-docs' : '';
      const statusIcon = `
        <div class="doc-status-icon ${iconClass}">
          <span class="material-icons">description</span>
          <span class="doc-status-badge ${badgeClass}">${docCount}</span>
        </div>
      `;
      
      return `
        <div class="school-card" id="${cardId}">
          <div class="school-card-header" onclick="toggleSchoolCard('${cardId}')">
            <div class="school-rank">${rank + 1}</div>
            <div class="school-main-info">
              <div class="school-name">${escapeHtml(school.universityName || '')}</div>
              <div class="school-faculty">${escapeHtml(school.faculty || '')}${school.department ? ' ' + escapeHtml(school.department) : ''}</div>
            </div>
            ${statusIcon}
            ${school.applicationType ? `<span class="school-badge ${typeClass}">${escapeHtml(school.applicationType)}</span>` : ''}
            <span class="material-icons school-expand">expand_more</span>
          </div>
          <div class="school-detail">
            <div class="school-detail-inner">
              <!-- 報告ボタン -->
              <div class="report-buttons" onclick="event.stopPropagation()">
                <button class="report-btn doc-btn" onclick="openDocModal('${escapeHtml(school.universityName || '')}', '${escapeHtml(school.faculty || '')}')">
                  <span class="material-icons">description</span>
                  書類提出
                  ${docCount > 0 ? `<span class="count">${docCount}</span>` : ''}
                </button>
                <button class="report-btn result-btn" disabled title="準備中">
                  <span class="material-icons">looks_one</span>
                  一次報告
                </button>
                <button class="report-btn result-btn" disabled title="準備中">
                  <span class="material-icons">looks_two</span>
                  二次報告
                </button>
              </div>
              ${renderDetailSections(school)}
            </div>
          </div>
        </div>
      `;
    }

    // ============================================
    // 詳細セクション生成
    // ============================================
    function renderDetailSections(school) {
      return `
        <div class="detail-section">
          <div class="detail-section-title">
            <span class="material-icons">info</span>基本情報
          </div>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">大学名</span>
              <span class="detail-value">${escapeHtml(school.universityName) || '<span class="empty">-</span>'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">学部・学科</span>
              <span class="detail-value">${escapeHtml(school.faculty || '')}${school.department ? ' ' + escapeHtml(school.department) : ''} ${!school.faculty ? '<span class="empty">-</span>' : ''}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">専願/併願</span>
              <span class="detail-value">${escapeHtml(school.applicationType) || '<span class="empty">-</span>'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">地域</span>
              <span class="detail-value">${escapeHtml(school.region) || '<span class="empty">-</span>'}</span>
            </div>
          </div>
        </div>
        
        <div class="detail-section">
          <div class="detail-section-title">
            <span class="material-icons">checklist</span>出願要件
          </div>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">評定条件</span>
              <span class="detail-value">${escapeHtml(school.gpaReq) || '<span class="empty">-</span>'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">英語要件</span>
              <span class="detail-value">${escapeHtml(school.englishReq) || '<span class="empty">-</span>'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">出願書類</span>
              <span class="detail-value">${escapeHtml(school.documents) || '<span class="empty">-</span>'}</span>
            </div>
          </div>
        </div>
        
        <div class="detail-section">
          <div class="detail-section-title">
            <span class="material-icons">quiz</span>試験内容
          </div>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">試験方式</span>
              <span class="detail-value">${escapeHtml(school.examType) || '<span class="empty">-</span>'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">小論文</span>
              <span class="detail-value">${escapeHtml(school.essay) || '<span class="empty">-</span>'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">面接</span>
              <span class="detail-value">${escapeHtml(school.interview) || '<span class="empty">-</span>'}</span>
            </div>
          </div>
        </div>
        
        <div class="detail-section">
          <div class="detail-section-title">
            <span class="material-icons">event</span>日程・データ
          </div>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">出願期間</span>
              <span class="detail-value">${escapeHtml(school.applicationPeriod) || '<span class="empty">-</span>'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">試験日</span>
              <span class="detail-value">${escapeHtml(school.examDate) || '<span class="empty">-</span>'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">合格発表</span>
              <span class="detail-value">${escapeHtml(school.resultDate) || '<span class="empty">-</span>'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">備考</span>
              <span class="detail-value">${escapeHtml(school.notes) || '<span class="empty">-</span>'}</span>
            </div>
          </div>
        </div>
      `;
    }

    function toggleSchoolCard(cardId) {
      document.getElementById(cardId).classList.toggle('open');
    }

    // ============================================
    // 表示モード切替（下部）
    // ============================================
    function setViewMode(mode) {
      currentViewMode = mode;
      document.querySelectorAll('.view-mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      
      document.getElementById('listView').classList.toggle('hidden', mode !== 'list');
      document.getElementById('compareView').classList.toggle('show', mode === 'compare');
    }

    // ============================================
    // 一覧表示：全パターンの全大学
    // ============================================
    function renderAllSchoolsList() {
      const container = document.getElementById('allSchoolsList');
      const emptyState = document.getElementById('listEmpty');
      
      let allSchools = [];
      ['A', 'B', 'C', 'D'].forEach(pattern => {
        (schoolPatterns[pattern] || []).forEach((school, index) => {
          allSchools.push({ pattern, rank: index + 1, school });
        });
      });
      
      if (allSchools.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }
      
      container.style.display = 'flex';
      emptyState.style.display = 'none';
      
      container.innerHTML = allSchools.map((item, idx) => {
        const { pattern, rank, school } = item;
        const typeClass = school.applicationType === '専願' ? 'sengan' : (school.applicationType === '併願' ? 'heigan' : '');
        const cardId = `list-${idx}`;
        const univKey = `${school.universityName}|${school.faculty}`;
        const docCount = documentSummary[univKey] || 0;
        
        // SNS通知風バッジ
        const badgeClass = docCount > 0 ? 'count-positive' : 'count-zero';
        const iconClass = docCount > 0 ? 'has-docs' : '';
        const statusIcon = `
          <div class="doc-status-icon ${iconClass}">
            <span class="material-icons">description</span>
            <span class="doc-status-badge ${badgeClass}">${docCount}</span>
          </div>
        `;
        
        return `
          <div class="list-school-card" id="${cardId}">
            <div class="list-school-header" onclick="toggleListCard('${cardId}')">
              <span class="list-pattern-badge pattern-${pattern.toLowerCase()}">${pattern} 第${rank}志望</span>
              <div class="list-school-info">
                <div class="list-school-name">${escapeHtml(school.universityName || '')}</div>
                <div class="list-school-faculty">${escapeHtml(school.faculty || '')}${school.department ? ' ' + escapeHtml(school.department) : ''}</div>
              </div>
              ${statusIcon}
              ${school.applicationType ? `<span class="school-badge ${typeClass}">${escapeHtml(school.applicationType)}</span>` : ''}
              <span class="material-icons school-expand">expand_more</span>
            </div>
            <div class="list-school-detail">
              <div class="school-detail-inner">
                <!-- 報告ボタン -->
                <div class="report-buttons" onclick="event.stopPropagation()">
                  <button class="report-btn doc-btn" onclick="openDocModal('${escapeHtml(school.universityName || '')}', '${escapeHtml(school.faculty || '')}')">
                    <span class="material-icons">description</span>
                    書類提出
                    ${docCount > 0 ? `<span class="count">${docCount}</span>` : ''}
                  </button>
                  <button class="report-btn result-btn" disabled title="準備中">
                    <span class="material-icons">looks_one</span>
                    一次報告
                  </button>
                  <button class="report-btn result-btn" disabled title="準備中">
                    <span class="material-icons">looks_two</span>
                    二次報告
                  </button>
                </div>
                ${renderDetailSections(school)}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleListCard(cardId) {
      document.getElementById(cardId).classList.toggle('open');
    }

    // ============================================
    // 全パターン比較：パターン選択
    // ============================================
    function selectComparePattern(pattern) {
      selectedComparePattern = pattern;
      document.querySelectorAll('.compare-pattern-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.pattern === pattern);
      });
      renderCompareCards();
    }

    // ============================================
    // 比較カード描画（横並び）
    // ============================================
    function renderCompareCards() {
      const container = document.getElementById('compareCards');
      const emptyState = document.getElementById('compareEmpty');
      const scrollHint = document.getElementById('scrollHint');
      const schools = schoolPatterns[selectedComparePattern] || [];
      
      if (schools.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        scrollHint.style.display = 'none';
        return;
      }
      
      emptyState.style.display = 'none';
      scrollHint.style.display = schools.length > 1 ? 'flex' : 'none';
      
      container.innerHTML = schools.map((school, index) => {
        const typeClass = school.applicationType === '専願' ? 'sengan' : (school.applicationType === '併願' ? 'heigan' : '');
        
        return `
          <div class="compare-card">
            <div class="compare-card-header">
              <div class="compare-card-rank">第${index + 1}志望</div>
              <div class="compare-card-name">${escapeHtml(school.universityName || '')}</div>
              <div class="compare-card-faculty">${escapeHtml(school.faculty || '')}${school.department ? ' ' + escapeHtml(school.department) : ''}</div>
              ${school.applicationType ? `<span class="compare-card-badge ${typeClass}">${escapeHtml(school.applicationType)}</span>` : ''}
            </div>
            
            <div class="compare-card-section">
              <div class="compare-card-section-title">
                <span class="material-icons">info</span>基本情報
              </div>
              <div class="compare-card-item">
                <span class="compare-card-item-label">地域</span>
                <span class="compare-card-item-value ${!school.region ? 'empty' : ''}">${escapeHtml(school.region) || '-'}</span>
              </div>
              <div class="compare-card-item">
                <span class="compare-card-item-label">試験方式</span>
                <span class="compare-card-item-value ${!school.examType ? 'empty' : ''}">${escapeHtml(school.examType) || '-'}</span>
              </div>
            </div>
            
            <div class="compare-card-section">
              <div class="compare-card-section-title">
                <span class="material-icons">checklist</span>出願要件
              </div>
              <div class="compare-card-item">
                <span class="compare-card-item-label">評定条件</span>
                <span class="compare-card-item-value ${!school.gpaReq ? 'empty' : ''}">${escapeHtml(school.gpaReq) || '-'}</span>
              </div>
              <div class="compare-card-item">
                <span class="compare-card-item-label">英語要件</span>
                <span class="compare-card-item-value ${!school.englishReq ? 'empty' : ''}">${escapeHtml(school.englishReq) || '-'}</span>
              </div>
              <div class="compare-card-item">
                <span class="compare-card-item-label">出願書類</span>
                <span class="compare-card-item-value ${!school.documents ? 'empty' : ''}">${escapeHtml(school.documents) || '-'}</span>
              </div>
            </div>
            
            <div class="compare-card-section">
              <div class="compare-card-section-title">
                <span class="material-icons">quiz</span>試験内容
              </div>
              <div class="compare-card-item">
                <span class="compare-card-item-label">小論文</span>
                <span class="compare-card-item-value ${!school.essay ? 'empty' : ''}">${escapeHtml(school.essay) || '-'}</span>
              </div>
              <div class="compare-card-item">
                <span class="compare-card-item-label">面接</span>
                <span class="compare-card-item-value ${!school.interview ? 'empty' : ''}">${escapeHtml(school.interview) || '-'}</span>
              </div>
            </div>
            
            <div class="compare-card-section">
              <div class="compare-card-section-title">
                <span class="material-icons">event</span>日程
              </div>
              <div class="compare-card-item">
                <span class="compare-card-item-label">出願期間</span>
                <span class="compare-card-item-value ${!school.applicationPeriod ? 'empty' : ''}">${escapeHtml(school.applicationPeriod) || '-'}</span>
              </div>
              <div class="compare-card-item">
                <span class="compare-card-item-label">試験日</span>
                <span class="compare-card-item-value ${!school.examDate ? 'empty' : ''}">${escapeHtml(school.examDate) || '-'}</span>
              </div>
              <div class="compare-card-item">
                <span class="compare-card-item-label">合格発表</span>
                <span class="compare-card-item-value ${!school.resultDate ? 'empty' : ''}">${escapeHtml(school.resultDate) || '-'}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ============================================
    // ユーティリティ
    // ============================================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================================
    // 倍率目安ポップアップ
    // ============================================
    function openRatioGuide() {
      document.getElementById('ratioGuideModal').classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeRatioGuide(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('ratioGuideModal').classList.remove('show');
      document.body.style.overflow = '';
    }

    // ESCキーでモーダルを閉じる
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeRatioGuide();
        closeAnabaModal();
      }
    });
  </script>

  <!-- ========================================
       穴場情報モーダル
  ======================================== -->
  <div class="anaba-modal-overlay" id="anabaModalOverlay" onclick="closeAnabaModal(event)">
    <div class="anaba-modal" onclick="event.stopPropagation()">
      <div class="anaba-modal-header">
        <div class="anaba-modal-title">
          <span class="material-icons">lightbulb</span>
          穴場・出願戦略情報
        </div>
        <button class="anaba-modal-close" onclick="closeAnabaModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="anaba-modal-body">
        <!-- カテゴリタブ -->
        <div class="anaba-tabs">
          <div class="anaba-tab active" data-category="穴場" onclick="selectAnabaCategory('穴場')">
            <span class="material-icons anaba-tab-icon">stars</span>
            穴場
          </div>
          <div class="anaba-tab" data-category="評定緩い" onclick="selectAnabaCategory('評定緩い')">
            <span class="material-icons anaba-tab-icon">assessment</span>
            評定基準
          </div>
          <div class="anaba-tab" data-category="英検不要" onclick="selectAnabaCategory('英検不要')">
            <span class="material-icons anaba-tab-icon">translate</span>
            英語資格
          </div>
          <div class="anaba-tab" data-category="併願専願" onclick="selectAnabaCategory('併願専願')">
            <span class="material-icons anaba-tab-icon">checklist</span>
            併願・専願
          </div>
        </div>

        <!-- 注意喚起エリア -->
        <div class="anaba-caution" id="anabaCaution">
          <div class="anaba-caution-title">
            <span class="material-icons">warning</span>
            <span id="anabaCautionTitle">このカテゴリの注意点</span>
          </div>
          <div class="anaba-caution-text" id="anabaCautionSummary"></div>
          <div class="anaba-caution-toggle" onclick="toggleCautionDetail()">
            <span>詳しく見る</span>
            <span class="material-icons" id="cautionToggleIcon">expand_more</span>
          </div>
          <div class="anaba-caution-detail" id="anabaCautionDetail"></div>
        </div>

        <!-- フィルタエリア -->
        <div class="anaba-filters">
          <div class="anaba-filter-group">
            <span class="anaba-filter-label">大学:</span>
            <select class="anaba-filter-select" id="anabaFilterUniv" onchange="filterAnabaList()">
              <option value="">すべて</option>
            </select>
          </div>
          <div class="anaba-filter-group">
            <span class="anaba-filter-label">エリア:</span>
            <select class="anaba-filter-select" id="anabaFilterArea" onchange="filterAnabaList()">
              <option value="">すべて</option>
              <option value="関東">関東</option>
              <option value="関西">関西</option>
            </select>
          </div>
          <div class="anaba-filter-group">
            <span class="anaba-filter-label">併願:</span>
            <select class="anaba-filter-select" id="anabaFilterHeigan" onchange="filterAnabaList()">
              <option value="">すべて</option>
              <option value="可">併願可</option>
              <option value="不可">専願のみ</option>
            </select>
          </div>
          <div class="anaba-result-count" id="anabaResultCount">0件</div>
        </div>

        <!-- データリスト -->
        <div class="anaba-list" id="anabaList">
          <div class="anaba-loading">
            <span class="material-icons">sync</span>
            <p>読み込み中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // 穴場情報機能
    // ========================================
    
    const ANABA_SPREADSHEET_ID = '1vL1u4LL8H-MnLut9owlXSpJLRHsuRhl8mIDE-0-8voM';
    let anabaData = [];
    let currentCategory = '穴場';
    let anabaDataLoaded = false;

    // 注意喚起テキスト
    const cautionTexts = {
      '穴場': {
        title: '穴場（低倍率）についての注意点',
        summary: '倍率が低い＝穴場ではありません。狙い目は"戦える土俵"かどうかです。',
        detail: '単純に倍率が低い学部を探すのではなく、「出願条件を満たし、自分の強みと噛み合い、論理的に戦える場所」を選ぶことが、合格への最短ルートです。\n\nここで紹介する学部はいずれも、「条件を満たす生徒には非常に有利に働く」「志望理由が合わせやすい」などの理由で"穴場"と呼べる枠です。\n\n適切な戦略を立てて、確実に合格を勝ち取りましょう。'
      },
      '評定緩い': {
        title: '評定基準が緩い大学についての注意点',
        summary: '評定不要＝受かりやすい、ではありません。他の要素がより厳しく評価されます。',
        detail: '評定平均の要件がないということは「評定平均が高くない人でも出願できる」というメリットがある一方で、同じように評定が高くない多くの受験生も殺到するため、倍率が高くなりやすい傾向があります。\n\n◆評定平均が見られない＝他の部分がより厳しく見られる\n出願時に評定を評価されない場合でも、その代わりに「活動実績」「研究プロセス」「志望理由書の完成度」「課外活動」「表現力」などが重視されます。\n\n◆戦略的に出願するための考え方\n自分が評定以外でどのような強みを持っているのかを明確にし、それをどのようにアピールするかを戦略的に考えることが重要です。'
      },
      '英検不要': {
        title: '英語資格が不要な大学についての注意点',
        summary: '英語資格が不要でも、他の要素（活動実績・志望理由等）で差がつきます。',
        detail: '英検などの語学資格条件がない学部・学科では、その分、活動実績や志望理由書の完成度、研究テーマの深さなどが重視される傾向があります。\n\n英語資格が不要だからといって「誰でも受かる」わけではなく、むしろ他の受験生と同じフィールドで厳しく比較されることになります。'
      },
      '併願専願': {
        title: '併願・専願についての注意点',
        summary: '併願可能な大学は戦略的に活用。専願の場合は覚悟を持って臨みましょう。',
        detail: '併願可能な大学は、複数の選択肢を持ちながら受験戦略を組み立てられるメリットがあります。\n\n一方、専願の大学は「合格したら必ず入学する」という約束のもとで出願するため、本当にその大学に行きたいかどうかを慎重に考える必要があります。\n\nまた、大学によっては「文言は曖昧だが実質専願」というケースもあるため、必ず募集要項を確認してください。'
      }
    };

    // モーダル開閉
    function openAnabaModal() {
      document.getElementById('anabaModalOverlay').classList.add('show');
      document.body.style.overflow = 'hidden';
      
      if (!anabaDataLoaded) {
        loadAnabaData();
      } else {
        renderAnabaList();
      }
    }

    function closeAnabaModal(e) {
      if (e && e.target !== e.currentTarget) return;
      document.getElementById('anabaModalOverlay').classList.remove('show');
      document.body.style.overflow = '';
    }

    // データ読み込み
    async function loadAnabaData() {
      try {
        const url = `https://docs.google.com/spreadsheets/d/${ANABA_SPREADSHEET_ID}/gviz/tq?tqx=out:json`;
        const response = await fetch(url);
        const text = await response.text();
        
        // JSONを抽出
        const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?$/);
        if (!jsonMatch) throw new Error('データ形式エラー');
        
        const json = JSON.parse(jsonMatch[1]);
        const rows = json.table.rows;
        
        // ヘッダーをスキップしてデータを取得
        anabaData = rows.slice(1).map(row => {
          const cells = row.c;
          return {
            univ: cells[0]?.v || '',
            faculty: cells[1]?.v || '',
            department: cells[2]?.v || '',
            method: cells[3]?.v || '',
            hyotei: cells[4]?.v || '',
            eiken: cells[5]?.v || '',
            heigan: cells[6]?.v || '',
            ratio: cells[7]?.v || '',
            category: cells[8]?.v || '',
            point: cells[9]?.v || '',
            area: cells[10]?.v || ''
          };
        }).filter(item => item.univ && item.category);
        
        anabaDataLoaded = true;
        updateUnivFilter();
        renderAnabaList();
        
      } catch (error) {
        console.error('穴場データ読み込みエラー:', error);
        document.getElementById('anabaList').innerHTML = `
          <div class="anaba-empty">
            <span class="material-icons">error</span>
            <p>データの読み込みに失敗しました</p>
          </div>
        `;
      }
    }

    // 大学フィルタ更新
    function updateUnivFilter() {
      const categoryData = anabaData.filter(item => item.category === currentCategory);
      const univs = [...new Set(categoryData.map(item => item.univ))].sort();
      
      const select = document.getElementById('anabaFilterUniv');
      select.innerHTML = '<option value="">すべて</option>' + 
        univs.map(u => `<option value="${u}">${u}</option>`).join('');
    }

    // カテゴリ選択
    function selectAnabaCategory(category) {
      currentCategory = category;
      
      // タブのアクティブ状態更新
      document.querySelectorAll('.anaba-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.category === category);
      });
      
      // 注意喚起テキスト更新
      updateCautionText();
      
      // フィルタリセット
      document.getElementById('anabaFilterUniv').value = '';
      document.getElementById('anabaFilterArea').value = '';
      document.getElementById('anabaFilterHeigan').value = '';
      
      // 大学フィルタ更新
      updateUnivFilter();
      
      // リスト描画
      renderAnabaList();
    }

    // 注意喚起テキスト更新
    function updateCautionText() {
      const caution = cautionTexts[currentCategory];
      document.getElementById('anabaCautionTitle').textContent = caution.title;
      document.getElementById('anabaCautionSummary').textContent = caution.summary;
      document.getElementById('anabaCautionDetail').innerHTML = caution.detail.replace(/\n/g, '<br>');
      
      // 詳細を閉じる
      document.getElementById('anabaCautionDetail').classList.remove('show');
      document.getElementById('cautionToggleIcon').textContent = 'expand_more';
    }

    // 詳細トグル
    function toggleCautionDetail() {
      const detail = document.getElementById('anabaCautionDetail');
      const icon = document.getElementById('cautionToggleIcon');
      const isOpen = detail.classList.toggle('show');
      icon.textContent = isOpen ? 'expand_less' : 'expand_more';
    }

    // フィルタリング
    function filterAnabaList() {
      renderAnabaList();
    }

    // リスト描画
    function renderAnabaList() {
      const listEl = document.getElementById('anabaList');
      
      // フィルタ値取得
      const filterUniv = document.getElementById('anabaFilterUniv').value;
      const filterArea = document.getElementById('anabaFilterArea').value;
      const filterHeigan = document.getElementById('anabaFilterHeigan').value;
      
      // フィルタリング
      let filtered = anabaData.filter(item => item.category === currentCategory);
      
      if (filterUniv) {
        filtered = filtered.filter(item => item.univ === filterUniv);
      }
      if (filterArea) {
        filtered = filtered.filter(item => item.area === filterArea);
      }
      if (filterHeigan) {
        filtered = filtered.filter(item => item.heigan === filterHeigan);
      }
      
      // 件数表示
      document.getElementById('anabaResultCount').textContent = `${filtered.length}件`;
      
      // 空の場合
      if (filtered.length === 0) {
        listEl.innerHTML = `
          <div class="anaba-empty">
            <span class="material-icons">search_off</span>
            <p>該当するデータがありません</p>
          </div>
        `;
        return;
      }
      
      // リスト生成
      listEl.innerHTML = filtered.map((item, index) => `
        <div class="anaba-item">
          <div class="anaba-item-header" onclick="toggleAnabaDetail(${index})">
            <div class="anaba-item-main">
              <div class="anaba-item-univ">${item.univ}</div>
              <div class="anaba-item-faculty">${item.faculty}${item.department ? ' ' + item.department : ''}</div>
              <div class="anaba-item-badges">
                ${item.hyotei ? `<span class="anaba-badge hyotei">評定: ${item.hyotei}</span>` : ''}
                ${item.eiken ? `<span class="anaba-badge eiken">英語: ${item.eiken}</span>` : ''}
                ${item.heigan === '可' ? '<span class="anaba-badge heigan">併願可</span>' : ''}
                ${item.heigan === '不可' || item.heigan === '専願' ? '<span class="anaba-badge sengan">専願</span>' : ''}
                ${item.ratio && item.ratio !== '-' ? `<span class="anaba-badge ratio">倍率: ${item.ratio}</span>` : ''}
              </div>
            </div>
            <span class="anaba-item-area">${item.area}</span>
            <span class="material-icons anaba-item-expand" id="anabaExpand${index}">expand_more</span>
          </div>
          <div class="anaba-item-detail" id="anabaDetail${index}">
            ${item.method ? `<div class="anaba-item-point"><strong>入試方式:</strong> ${item.method}</div>` : ''}
            ${item.point ? `<div class="anaba-item-point">${item.point}</div>` : ''}
          </div>
        </div>
      `).join('');
    }

    // 詳細トグル
    function toggleAnabaDetail(index) {
      const detail = document.getElementById(`anabaDetail${index}`);
      const icon = document.getElementById(`anabaExpand${index}`);
      const isOpen = detail.classList.toggle('show');
      icon.classList.toggle('open', isOpen);
    }

    // 初期化時に注意喚起テキスト設定
    updateCautionText();
  </script>

  <!-- ========================================
       書類提出モーダル
  ======================================== -->
  <div class="doc-modal-overlay" id="docModalOverlay" onclick="closeDocModal(event)">
    <div class="doc-modal" onclick="event.stopPropagation()">
      <div class="doc-modal-header">
        <div>
          <div class="doc-modal-title">
            <span class="material-icons">description</span>
            書類提出
          </div>
          <div class="doc-modal-univ" id="docModalUniv"></div>
        </div>
        <button class="doc-modal-close" onclick="closeDocModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="doc-modal-body">
        <!-- 入力フォーム -->
        <div class="doc-form-group">
          <label class="doc-form-label">書類の種類</label>
          <input type="text" class="doc-form-input" id="docType" placeholder="例：志望理由書、活動報告書など">
        </div>

        <div class="doc-form-group">
          <label class="doc-form-label">入力方法</label>
          <div class="doc-input-type">
            <label>
              <input type="radio" name="inputType" value="text" checked onchange="toggleInputType()">
              テキストで入力
            </label>
            <label>
              <input type="radio" name="inputType" value="file" onchange="toggleInputType()">
              ファイルをアップロード
            </label>
          </div>
        </div>

        <!-- テキスト入力 -->
        <div class="doc-text-wrapper show" id="docTextWrapper">
          <textarea class="doc-form-textarea" id="docContent" placeholder="書類の内容を入力してください..."></textarea>
        </div>

        <!-- ファイルアップロード -->
        <div class="doc-file-input-wrapper" id="docFileWrapper">
          <label class="doc-file-label" for="docFileInput">
            <span class="material-icons">cloud_upload</span>
            <span>クリックしてファイルを選択</span>
          </label>
          <input type="file" class="doc-file-input" id="docFileInput" accept="image/*,.pdf,.doc,.docx" onchange="handleFileSelect(event)">
          <div class="doc-file-selected" id="docFileSelected">
            <span class="material-icons">insert_drive_file</span>
            <span class="file-name" id="docFileName"></span>
            <button class="remove-file" onclick="removeSelectedFile()">
              <span class="material-icons">close</span>
            </button>
          </div>
        </div>

        <button class="doc-submit-btn" id="docSubmitBtn" onclick="submitDocument()">
          <span class="material-icons">send</span>
          提出する
        </button>

        <!-- 履歴セクション -->
        <div class="doc-history-section">
          <div class="doc-history-title">
            <span class="material-icons">history</span>
            提出履歴
          </div>
          <div class="doc-history-list" id="docHistoryList">
            <div class="doc-history-empty">まだ提出履歴はありません</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 書類内容表示モーダル -->
  <div class="doc-modal-overlay" id="docContentModalOverlay" onclick="closeDocContentModal(event)">
    <div class="doc-modal doc-content-modal" onclick="event.stopPropagation()">
      <div class="doc-modal-header">
        <div>
          <div class="doc-modal-title">
            <span class="material-icons">article</span>
            <span id="docContentTitle">書類内容</span>
          </div>
          <div class="doc-modal-univ" id="docContentDate"></div>
        </div>
        <button class="doc-modal-close" onclick="closeDocContentModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="doc-modal-body">
        <div id="docContentBody"></div>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // 書類提出機能
    // ========================================
    
    const DOCUMENT_SPREADSHEET_ID = '1mNdZJWWR_9UnNIy6LvLZ7a3TqdTAz3mVQilbNk85AyU';
    let currentDocUniv = '';
    let currentDocFaculty = '';
    let selectedFile = null;
    let documentSummary = {};

    // モーダル開閉
    function openDocModal(univName, faculty) {
      currentDocUniv = univName;
      currentDocFaculty = faculty;
      
      document.getElementById('docModalUniv').textContent = `${univName} ${faculty}`;
      document.getElementById('docType').value = '';
      document.getElementById('docContent').value = '';
      removeSelectedFile();
      
      // テキスト入力をデフォルトに
      document.querySelector('input[name="inputType"][value="text"]').checked = true;
      toggleInputType();
      
      // 履歴を読み込み
      loadDocumentHistory();
      
      document.getElementById('docModalOverlay').classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeDocModal(e) {
      if (e && e.target !== e.currentTarget) return;
      document.getElementById('docModalOverlay').classList.remove('show');
      document.body.style.overflow = '';
    }

    function closeDocContentModal(e) {
      if (e && e.target !== e.currentTarget) return;
      document.getElementById('docContentModalOverlay').classList.remove('show');
    }

    // 入力タイプ切り替え
    function toggleInputType() {
      const inputType = document.querySelector('input[name="inputType"]:checked').value;
      document.getElementById('docTextWrapper').classList.toggle('show', inputType === 'text');
      document.getElementById('docFileWrapper').classList.toggle('show', inputType === 'file');
    }

    // ファイル選択処理
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        selectedFile = file;
        document.getElementById('docFileName').textContent = file.name;
        document.getElementById('docFileSelected').classList.add('show');
      }
    }

    function removeSelectedFile() {
      selectedFile = null;
      document.getElementById('docFileInput').value = '';
      document.getElementById('docFileSelected').classList.remove('show');
    }

    // 書類提出
    async function submitDocument() {
      const docType = document.getElementById('docType').value.trim();
      const inputType = document.querySelector('input[name="inputType"]:checked').value;
      const content = document.getElementById('docContent').value.trim();
      
      if (!docType) {
        alert('書類の種類を入力してください');
        return;
      }
      
      if (inputType === 'text' && !content) {
        alert('内容を入力してください');
        return;
      }
      
      if (inputType === 'file' && !selectedFile) {
        alert('ファイルを選択してください');
        return;
      }
      
      // ログイン中の生徒番号を取得
      const studentId = localStorage.getItem('studentNumber') || '';
      if (!studentId) {
        alert('ログインが必要です');
        return;
      }
      
      const submitBtn = document.getElementById('docSubmitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="material-icons">sync</span> 送信中...';
      
      try {
        let requestData = {
          studentId: studentId,
          univName: currentDocUniv,
          faculty: currentDocFaculty,
          docType: docType,
          inputType: inputType
        };
        
        if (inputType === 'text') {
          requestData.content = content;
        } else {
          // ファイルをBase64に変換
          const base64Data = await fileToBase64(selectedFile);
          requestData.fileData = base64Data;
          requestData.fileName = selectedFile.name;
          requestData.mimeType = selectedFile.type;
        }
        
        const response = await fetch(API_URL + '?action=submitDocument', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('書類を提出しました');
          document.getElementById('docType').value = '';
          document.getElementById('docContent').value = '';
          removeSelectedFile();
          
          // 履歴を再読み込み
          loadDocumentHistory();
          
          // サマリーを更新
          loadDocumentSummary();
        } else {
          alert('エラー: ' + (result.error || '送信に失敗しました'));
        }
        
      } catch (error) {
        console.error('書類提出エラー:', error);
        alert('送信中にエラーが発生しました');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span class="material-icons">send</span> 提出する';
      }
    }

    // ファイルをBase64に変換
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = error => reject(error);
      });
    }

    // 書類履歴を読み込み
    async function loadDocumentHistory() {
      const historyList = document.getElementById('docHistoryList');
      const studentId = localStorage.getItem('studentNumber') || '';
      
      if (!studentId) {
        historyList.innerHTML = '<div class="doc-history-empty">ログインが必要です</div>';
        return;
      }
      
      historyList.innerHTML = '<div class="doc-history-empty">読み込み中...</div>';
      
      try {
        const params = new URLSearchParams({
          action: 'getDocumentHistory',
          studentId: studentId,
          univName: currentDocUniv,
          faculty: currentDocFaculty
        });
        
        const response = await fetch(API_URL + '?' + params);
        const result = await response.json();
        
        if (result.success && result.history && result.history.length > 0) {
          historyList.innerHTML = result.history.map(item => `
            <div class="doc-history-item">
              <div class="doc-history-item-info">
                <div class="doc-history-item-type">
                  ${escapeHtml(item.docType)}
                  <span class="doc-history-item-badge ${item.inputType}">${item.inputType === 'text' ? 'テキスト' : 'ファイル'}</span>
                </div>
                <div class="doc-history-item-date">${item.timestamp}</div>
              </div>
              <button class="doc-history-view-btn" onclick="viewDocumentContent(${item.id})">
                内容を見る
              </button>
            </div>
          `).join('');
        } else {
          historyList.innerHTML = '<div class="doc-history-empty">まだ提出履歴はありません</div>';
        }
        
      } catch (error) {
        console.error('履歴取得エラー:', error);
        historyList.innerHTML = '<div class="doc-history-empty">読み込みに失敗しました</div>';
      }
    }

    // 書類内容を表示
    async function viewDocumentContent(rowId) {
      try {
        const params = new URLSearchParams({
          action: 'getDocumentContent',
          rowId: rowId
        });
        
        const response = await fetch(API_URL + '?' + params);
        const result = await response.json();
        
        if (result.success && result.document) {
          const doc = result.document;
          document.getElementById('docContentTitle').textContent = doc.docType;
          document.getElementById('docContentDate').textContent = doc.timestamp;
          
          if (doc.inputType === 'text') {
            document.getElementById('docContentBody').innerHTML = `
              <div class="doc-content-body">${escapeHtml(doc.content)}</div>
            `;
          } else {
            document.getElementById('docContentBody').innerHTML = `
              <a href="${doc.content}" target="_blank" class="doc-content-file-link">
                <span class="material-icons">open_in_new</span>
                ${escapeHtml(doc.fileName)} を開く
              </a>
            `;
          }
          
          document.getElementById('docContentModalOverlay').classList.add('show');
        } else {
          alert('内容の取得に失敗しました');
        }
        
      } catch (error) {
        console.error('内容取得エラー:', error);
        alert('読み込み中にエラーが発生しました');
      }
    }

    // 書類サマリーを読み込み（カード表示用）
    async function loadDocumentSummary() {
      const studentId = localStorage.getItem('studentNumber') || '';
      if (!studentId) return;
      
      try {
        const params = new URLSearchParams({
          action: 'getDocumentSummary',
          studentId: studentId
        });
        
        const response = await fetch(API_URL + '?' + params);
        const result = await response.json();
        
        if (result.success && result.summary) {
          documentSummary = {};
          result.summary.forEach(item => {
            const key = `${item.univName}|${item.faculty}`;
            documentSummary[key] = item.count;
          });
          
          // カードを再描画
          renderPatternSchools();
          if (currentListView === 'list') {
            renderListViewSchools();
          }
        }
        
      } catch (error) {
        console.error('サマリー取得エラー:', error);
      }
    }

    // ページ読み込み時にサマリーを取得
    document.addEventListener('DOMContentLoaded', function() {
      // 少し遅延させてログイン状態確認後に実行
      setTimeout(loadDocumentSummary, 1000);
    });
  </script>
  <script src="js/nav-menu.js"></script>
</body>
</html>
