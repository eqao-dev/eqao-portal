<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>授業スケジュール - EQAO PORTAL</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="css/nav-menu.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #f8f9fc 0%, #e8ecf4 100%);
      min-height: 100vh;
      padding-bottom: 40px;
    }

    .header {
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
      color: white;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 4px 20px rgba(26, 35, 126, 0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .back-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    .header-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 2px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px 16px;
    }

    /* ユーザー情報 */
    .user-info {
      background: white;
      border-radius: 16px;
      padding: 16px 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #4527a0 0%, #7e57c2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .user-avatar.admin {
      background: linear-gradient(135deg, #c62828 0%, #ef5350 100%);
    }

    .user-avatar .material-icons {
      color: white;
      font-size: 24px;
    }

    .user-details {
      flex: 1;
    }

    .user-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .user-id {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
    }

    .logout-btn {
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      padding: 8px;
    }

    /* ローディング */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e0e0e0;
      border-top-color: #1a237e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* スケジュールリスト */
    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .schedule-card {
      background: white;
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      display: flex;
      gap: 16px;
    }

    .schedule-date {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 60px;
      padding: 8px;
      background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
      border-radius: 12px;
      color: white;
    }

    .schedule-date .month-day {
      font-size: 18px;
      font-weight: 700;
    }

    .schedule-date .day-of-week {
      font-size: 11px;
      margin-top: 2px;
      opacity: 0.9;
    }

    .schedule-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 6px;
    }

    .schedule-time {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .schedule-time .material-icons {
      font-size: 18px;
      color: #1a237e;
    }

    .schedule-teacher {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #666;
    }

    .schedule-teacher .material-icons {
      font-size: 16px;
      color: #888;
    }

    /* 結果なし */
    .no-results {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .no-results .material-icons {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* ログイン・パスワード変更フォーム共通 */
    .form-box {
      background: white;
      border-radius: 20px;
      padding: 32px 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .form-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
    }

    .form-icon.warning {
      background: linear-gradient(135deg, #f57c00 0%, #ffb74d 100%);
    }

    .form-icon .material-icons {
      font-size: 32px;
      color: white;
    }

    .form-title {
      font-size: 20px;
      color: #1a237e;
      margin-bottom: 8px;
    }

    .form-subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 16px;
      text-align: left;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: #1a237e;
    }

    .form-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .form-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(26, 35, 126, 0.3);
    }

    .form-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 16px;
      text-align: left;
    }

    .success-message {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 16px;
      text-align: left;
    }

    /* 生徒選択（管理者用） */
    .student-select-box {
      background: white;
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .student-select-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
    }

    .student-select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      background: white;
      cursor: pointer;
    }

    .student-select:focus {
      outline: none;
      border-color: #1a237e;
    }

    /* レスポンシブ */
    @media (max-width: 480px) {
      .header-title {
        font-size: 16px;
      }
    }

    /* フォームリンクセクション */
    .form-links {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .form-link-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 12px;
      background: white;
      border: 2px solid #1a237e;
      border-radius: 12px;
      color: #1a237e;
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .form-link-btn:hover {
      background: #1a237e;
      color: white;
    }

    .form-link-btn .material-icons {
      font-size: 20px;
    }

    /* 月選択 */
    .month-selector {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 12px;
      margin-bottom: 16px;
      -webkit-overflow-scrolling: touch;
    }

    .month-btn {
      flex-shrink: 0;
      padding: 10px 18px;
      border: 2px solid #ddd;
      background: white;
      color: #666;
      font-size: 14px;
      font-weight: 600;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .month-btn.active {
      background: #1a237e;
      color: white;
      border-color: #1a237e;
    }

    /* 授業種類別の色 */
    .schedule-date.type-normal {
      background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
    }

    .schedule-date.type-english {
      background: linear-gradient(135deg, #880e4f 0%, #ad1457 100%);
    }

    .schedule-date.type-essay {
      background: linear-gradient(135deg, #e65100 0%, #f57c00 100%);
    }

    .schedule-date.type-interview {
      background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
    }

    /* 凡例 */
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #666;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    .legend-color.type-normal {
      background: #1a237e;
    }

    .legend-color.type-english {
      background: #880e4f;
    }

    .legend-color.type-essay {
      background: #e65100;
    }

    .legend-color.type-interview {
      background: #1b5e20;
    }

    /* ハンバーガーメニュー */
    .hamburger-btn {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .nav-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .nav-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .nav-menu {
      position: fixed;
      top: 0;
      right: -300px;
      width: 280px;
      height: 100%;
      background: white;
      z-index: 201;
      transition: right 0.3s ease;
      box-shadow: -4px 0 20px rgba(0,0,0,0.15);
      overflow-y: auto;
    }

    .nav-menu.open {
      right: 0;
    }

    .nav-header {
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
      color: white;
      padding: 20px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav-header-title {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .nav-user-section {
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #283593 0%, #3949ab 100%);
    }

    .nav-user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
    }

    .nav-user-info .material-icons {
      font-size: 24px;
      color: rgba(255,255,255,0.7);
    }

    .nav-user-name {
      font-size: 14px;
      font-weight: 500;
    }

    .nav-logout-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 8px;
      color: rgba(255,255,255,0.9);
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
      font-family: inherit;
    }

    .nav-logout-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    .nav-logout-btn .material-icons {
      font-size: 16px;
    }

    .nav-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
    }

    .nav-category {
      font-size: 11px;
      font-weight: 700;
      color: #999;
      padding: 16px 16px 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .nav-section {
      padding: 4px 0;
      border-bottom: 1px solid #eee;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: #333;
      text-decoration: none;
      transition: background 0.2s;
    }

    .nav-item:hover {
      background: #f5f5f5;
    }

    .nav-item .material-icons {
      font-size: 22px;
      color: #1a237e;
    }

    .nav-item span {
      font-size: 14px;
      font-weight: 500;
    }

    .nav-badge {
      background: #ff5722;
      color: white;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: auto;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .nav-badge-wip {
      background: #9e9e9e;
      color: white;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: auto;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .nav-item.disabled {
      color: #bbb;
      cursor: not-allowed;
      pointer-events: none;
    }

    .nav-item.disabled .material-icons {
      color: #ccc;
    }

  </style>
</head>
<body>
  <header class="header">
    <button class="back-btn" onclick="goBack()">
      <span class="material-icons">arrow_back</span>
    </button>
    <h1 class="header-title">授業スケジュール</h1>
  </header>

  <!-- ハンバーガーボタン -->
  <button class="hamburger-btn" onclick="openNav()">
    <span class="material-icons">menu</span>
  </button>

  <!-- ナビゲーションオーバーレイ -->

  <!-- ナビゲーションメニュー -->
<div class="container">
    <!-- ユーザー情報 -->
    <div id="userInfo" class="user-info" style="display: none;">
      <div id="userAvatar" class="user-avatar">
        <span class="material-icons">person</span>
      </div>
      <div class="user-details">
        <div id="userName" class="user-name"></div>
        <div id="userId" class="user-id"></div>
      </div>
      <button class="logout-btn" onclick="logout()" title="ログアウト">
        <span class="material-icons">logout</span>
      </button>
    </div>

    <!-- 生徒選択（管理者用） -->
    <div id="studentSelectBox" class="student-select-box" style="display: none;">
      <div class="student-select-title">表示する生徒を選択</div>
      <select id="studentSelect" class="student-select" onchange="onStudentSelect()">
        <option value="">-- 生徒を選択してください --</option>
      </select>
    </div>

    <!-- フォームリンク -->
    <div id="formLinks" class="form-links" style="display: none;">
      <a href="https://forms.gle/MsgLeyMra9HVKtqe8" target="_blank" class="form-link-btn">
        <span class="material-icons">swap_horiz</span>
        振替申請
      </a>
      <a href="https://forms.gle/QxoopUMo9eaBLPVr6" target="_blank" class="form-link-btn">
        <span class="material-icons">add_circle</span>
        追加コマ申請
      </a>
    </div>

    <!-- 月選択 -->
    <div id="monthSelector" class="month-selector" style="display: none;"></div>

    <!-- 凡例 -->
    <div id="legend" class="legend" style="display: none;">
      <div class="legend-item">
        <div class="legend-color type-normal"></div>
        <span>通常授業</span>
      </div>
      <div class="legend-item">
        <div class="legend-color type-english"></div>
        <span>英語対策</span>
      </div>
      <div class="legend-item">
        <div class="legend-color type-essay"></div>
        <span>小論文講座</span>
      </div>
      <div class="legend-item">
        <div class="legend-color type-interview"></div>
        <span>面接対策</span>
      </div>
    </div>

    <!-- ローディング -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>読み込み中...</p>
    </div>

    <!-- スケジュールリスト -->
    <div id="scheduleList" class="schedule-list" style="display: none;"></div>
    
    <!-- 結果なし -->
    <div id="noResults" class="no-results" style="display: none;">
      <span class="material-icons">event_busy</span>
      <p>予定されている授業はありません</p>
    </div>

    <!-- ログインフォーム -->
    <div id="loginForm" style="display: none;">
      <div class="form-box">
        <div class="form-icon">
          <span class="material-icons">lock</span>
        </div>
        <h2 class="form-title">ログイン</h2>
        <p class="form-subtitle">生徒番号とパスワードを入力してください</p>
        
        <div id="loginError" class="error-message" style="display: none;"></div>
        
        <div class="form-group">
          <label class="form-label">生徒番号</label>
          <input type="text" id="studentIdInput" class="form-input" placeholder="例：0001">
        </div>
        
        <div class="form-group">
          <label class="form-label">パスワード</label>
          <input type="password" id="passwordInput" class="form-input" placeholder="パスワード" onkeypress="if(event.key==='Enter')login()">
        </div>
        
        <button id="loginBtn" class="form-btn" onclick="login()">ログイン</button>
      </div>
    </div>

    <!-- パスワード変更フォーム -->
    <div id="passwordChangeForm" style="display: none;">
      <div class="form-box">
        <div class="form-icon warning">
          <span class="material-icons">vpn_key</span>
        </div>
        <h2 class="form-title">パスワードを変更してください</h2>
        <p class="form-subtitle">初回ログインのため、新しいパスワードを設定してください</p>
        
        <div id="passwordError" class="error-message" style="display: none;"></div>
        <div id="passwordSuccess" class="success-message" style="display: none;"></div>
        
        <div class="form-group">
          <label class="form-label">新しいパスワード</label>
          <input type="password" id="newPasswordInput" class="form-input" placeholder="4文字以上">
        </div>
        
        <div class="form-group">
          <label class="form-label">新しいパスワード（確認）</label>
          <input type="password" id="confirmPasswordInput" class="form-input" placeholder="もう一度入力" onkeypress="if(event.key==='Enter')changePassword()">
        </div>
        
        <button id="changePasswordBtn" class="form-btn" onclick="changePassword()">パスワードを変更</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // API設定
    // ============================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbyXdCxzPU6oXAm2Mi9mfMDeNvQAyE0mmTOABA2EOYelvX6J2Rr48VcizS0vMgIS7Qc7/exec';

    async function apiGet(action, params = {}) {
      const url = new URL(API_URL);
      url.searchParams.set('action', action);
      for (const [key, value] of Object.entries(params)) {
        if (value !== undefined && value !== null) {
          url.searchParams.set(key, value);
        }
      }
      const response = await fetch(url.toString());
      if (!response.ok) throw new Error('API Error: ' + response.status);
      return await response.json();
    }

    async function apiPost(action, data = {}) {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, ...data })
      });
      if (!response.ok) throw new Error('API Error: ' + response.status);
      return await response.json();
    }

    const BASE_URL = 'index.html';
    
    // 状態管理
    let currentUser = null;
    let allScheduleData = [];
    let selectedMonth = null;

    // 戻るボタン
    function goBack() {
      window.location.href = 'index.html?t=' + new Date().getTime();
    }

    // ログアウト
    function logout() {
      localStorage.removeItem('eqao_studentId');
      localStorage.removeItem('eqao_studentName');
      localStorage.removeItem('eqao_password');
      localStorage.removeItem('eqao_loggedIn');
      localStorage.removeItem('eqao_isAdmin');
      localStorage.removeItem('eqao_rowIndex');
      location.reload();
    }

    // ページ読み込み時
    document.addEventListener('DOMContentLoaded', function() {
      checkLoginAndLoad();
    });

    // ログイン確認してデータ読み込み
    function checkLoginAndLoad() {
      const loggedIn = localStorage.getItem('eqao_loggedIn');
      const studentId = localStorage.getItem('eqao_studentId');
      const studentName = localStorage.getItem('eqao_studentName');
      const isAdmin = localStorage.getItem('eqao_isAdmin') === 'true';

      if (!loggedIn || !studentId) {
        // 未ログインならindex.htmlへリダイレクト
        window.location.href = 'index.html';
        return;
      }

      currentUser = {
        studentId: studentId,
        studentName: studentName,
        isAdmin: isAdmin
      };
      showUserInfo();

      if (isAdmin) {
        loadStudentList();
      } else {
        loadSchedule(studentId);
      }
    }

    // ユーザー情報を表示
    function showUserInfo() {
      document.getElementById('userName').textContent = currentUser.studentName || '生徒';
      document.getElementById('userId').textContent = currentUser.isAdmin ? '管理者' : '生徒番号: ' + currentUser.studentId;
      if (currentUser.isAdmin) {
        document.getElementById('userAvatar').classList.add('admin');
        document.getElementById('userAvatar').innerHTML = '<span class="material-icons">admin_panel_settings</span>';
      }
      document.getElementById('userInfo').style.display = 'flex';
      document.getElementById('loading').style.display = 'block';
    }

    // ログイン処理（パスワード変更時のみ使用）
    async function login() {
      const studentId = document.getElementById('studentIdInput').value.trim();
      const password = document.getElementById('passwordInput').value;
      const errorMessage = document.getElementById('loginError');
      const loginBtn = document.getElementById('loginBtn');

      if (!studentId || !password) {
        errorMessage.textContent = '生徒番号とパスワードを入力してください';
        errorMessage.style.display = 'block';
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'ログイン中...';
      errorMessage.style.display = 'none';

      try {
        const result = await apiGet('authenticate', { studentId, password });
        
        if (result.success) {
          if (result.needsPasswordChange) {
            currentUser = result;
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('passwordChangeForm').style.display = 'block';
          } else {
            localStorage.setItem('eqao_studentId', result.studentId);
            localStorage.setItem('eqao_studentName', result.studentName);
            localStorage.setItem('eqao_password', password);
            localStorage.setItem('eqao_loggedIn', 'true');
            localStorage.setItem('eqao_isAdmin', result.isAdmin ? 'true' : 'false');
            localStorage.setItem('eqao_rowIndex', result.rowIndex);
            
            currentUser = result;
            
            document.getElementById('loginForm').style.display = 'none';
            showUserInfo();
            
            if (result.isAdmin) {
              loadStudentList();
            } else {
              loadSchedule(result.studentId);
            }
          }
        } else {
          errorMessage.textContent = '生徒番号またはパスワードが正しくありません';
          errorMessage.style.display = 'block';
          loginBtn.disabled = false;
          loginBtn.textContent = 'ログイン';
        }
      } catch (error) {
        errorMessage.textContent = 'エラーが発生しました。もう一度お試しください。';
        errorMessage.style.display = 'block';
        loginBtn.disabled = false;
        loginBtn.textContent = 'ログイン';
        console.error(error);
      }
    }

    // パスワード変更処理
    async function changePassword() {
      const newPassword = document.getElementById('newPasswordInput').value;
      const confirmPassword = document.getElementById('confirmPasswordInput').value;
      const errorMessage = document.getElementById('passwordError');
      const successMessage = document.getElementById('passwordSuccess');
      const changeBtn = document.getElementById('changePasswordBtn');

      errorMessage.style.display = 'none';
      successMessage.style.display = 'none';

      if (!newPassword || newPassword.length < 4) {
        errorMessage.textContent = 'パスワードは4文字以上で入力してください';
        errorMessage.style.display = 'block';
        return;
      }

      if (newPassword !== confirmPassword) {
        errorMessage.textContent = 'パスワードが一致しません';
        errorMessage.style.display = 'block';
        return;
      }

      if (newPassword === '0000') {
        errorMessage.textContent = '初期パスワードと同じパスワードは使用できません';
        errorMessage.style.display = 'block';
        return;
      }

      changeBtn.disabled = true;
      changeBtn.textContent = '変更中...';

      try {
        const result = await apiGet('changePassword', {
          studentId: currentUser.studentId,
          currentPassword: '0000',
          newPassword: newPassword
        });
        
        if (result.success) {
          successMessage.textContent = 'パスワードを変更しました。ログインしてください。';
          successMessage.style.display = 'block';
          
          setTimeout(function() {
            document.getElementById('passwordChangeForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('passwordInput').value = '';
          }, 2000);
        } else {
          errorMessage.textContent = 'パスワードの変更に失敗しました';
          errorMessage.style.display = 'block';
          changeBtn.disabled = false;
          changeBtn.textContent = 'パスワードを変更';
        }
      } catch (error) {
        errorMessage.textContent = 'エラーが発生しました';
        errorMessage.style.display = 'block';
        changeBtn.disabled = false;
        changeBtn.textContent = 'パスワードを変更';
        console.error(error);
      }
    }

    // 生徒リストを読み込み（管理者用）
    async function loadStudentList() {
      try {
        const students = await apiGet('getAllStudents');
        const select = document.getElementById('studentSelect');
        select.innerHTML = '<option value="">-- 生徒を選択してください --</option>';
        
        students.forEach(function(student) {
          const option = document.createElement('option');
          option.value = student.studentId;
          option.textContent = student.studentId + ' - ' + student.studentName;
          select.appendChild(option);
        });
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('studentSelectBox').style.display = 'block';
      } catch (error) {
        handleError(error);
      }
    }

    // 生徒選択時
    function onStudentSelect() {
      const studentId = document.getElementById('studentSelect').value;
      
      if (!studentId) {
        document.getElementById('scheduleList').style.display = 'none';
        document.getElementById('noResults').style.display = 'none';
        return;
      }
      
      document.getElementById('scheduleList').innerHTML = '';
      document.getElementById('noResults').style.display = 'none';
      document.getElementById('loading').style.display = 'block';
      
      loadSchedule(studentId);
    }

    // スケジュールを読み込み
    async function loadSchedule(studentId) {
      try {
        const data = await apiGet('getSchedule', { studentId });
        displaySchedule(data);
      } catch (error) {
        handleError(error);
      }
    }

    // スケジュールを表示
    function displaySchedule(data) {
      document.getElementById('loading').style.display = 'none';
      
      if (!data || data.length === 0) {
        document.getElementById('noResults').style.display = 'block';
        document.getElementById('formLinks').style.display = 'none';
        document.getElementById('monthSelector').style.display = 'none';
        document.getElementById('legend').style.display = 'none';
        return;
      }

      // データを保存
      allScheduleData = data;

      // フォームリンク、凡例を表示
      document.getElementById('formLinks').style.display = 'flex';
      document.getElementById('legend').style.display = 'flex';

      // 月選択を生成
      renderMonthSelector(data);

      // 初期表示は現在の月
      if (!selectedMonth) {
        const now = new Date();
        selectedMonth = (now.getMonth() + 1);
      }
      
      // フィルタして表示
      renderScheduleList();
    }

    // 月選択を描画
    function renderMonthSelector(data) {
      const container = document.getElementById('monthSelector');
      
      // データから月を抽出（重複排除）
      const months = [...new Set(data.map(item => item.month))].sort((a, b) => {
        // 年度順にソート（4月始まり）
        const aOrder = a >= 4 ? a - 4 : a + 8;
        const bOrder = b >= 4 ? b - 4 : b + 8;
        return aOrder - bOrder;
      });

      if (months.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'flex';
      container.innerHTML = '';

      // 「全て」ボタン
      const allBtn = document.createElement('button');
      allBtn.className = 'month-btn' + (selectedMonth === null ? ' active' : '');
      allBtn.textContent = '全て';
      allBtn.onclick = function() { selectMonth(null); };
      container.appendChild(allBtn);

      // 各月ボタン
      months.forEach(month => {
        const btn = document.createElement('button');
        btn.className = 'month-btn' + (selectedMonth === month ? ' active' : '');
        btn.textContent = month + '月';
        btn.onclick = function() { selectMonth(month); };
        container.appendChild(btn);
      });
    }

    // 月を選択
    function selectMonth(month) {
      selectedMonth = month;
      
      // ボタンのアクティブ状態を更新
      document.querySelectorAll('.month-btn').forEach(btn => {
        if (month === null && btn.textContent === '全て') {
          btn.classList.add('active');
        } else if (btn.textContent === month + '月') {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      renderScheduleList();
    }

    // スケジュールリストを描画
    function renderScheduleList() {
      const scheduleList = document.getElementById('scheduleList');
      scheduleList.innerHTML = '';

      // フィルタリング
      let filteredData = allScheduleData;
      if (selectedMonth !== null) {
        filteredData = allScheduleData.filter(item => item.month === selectedMonth);
      }

      if (filteredData.length === 0) {
        document.getElementById('scheduleList').style.display = 'none';
        document.getElementById('noResults').style.display = 'block';
        document.getElementById('noResults').innerHTML = `
          <span class="material-icons">event_busy</span>
          <p>この月の授業はありません</p>
        `;
        return;
      }

      document.getElementById('noResults').style.display = 'none';
      scheduleList.style.display = 'flex';

      filteredData.forEach(function(item) {
        const card = document.createElement('div');
        card.className = 'schedule-card';

        // 授業種類に応じたクラス
        const typeClass = getTypeClass(item.type);

        card.innerHTML = `
          <div class="schedule-date ${typeClass}">
            <div class="month-day">${escapeHtml(item.date)}</div>
            <div class="day-of-week">${escapeHtml(item.startTime)}</div>
          </div>
          <div class="schedule-details">
            <div class="schedule-time">
              <span class="material-icons">school</span>
              ${escapeHtml(item.type)}
            </div>
            <div class="schedule-teacher">
              <span class="material-icons">person</span>
              ${escapeHtml(item.teacher)}（${escapeHtml(item.format)}）
            </div>
          </div>
        `;

        scheduleList.appendChild(card);
      });
    }

    // 授業種類に応じたCSSクラスを取得
    function getTypeClass(type) {
      if (!type) return 'type-normal';
      if (type.includes('英語')) return 'type-english';
      if (type.includes('小論文')) return 'type-essay';
      if (type.includes('面接')) return 'type-interview';
      return 'type-normal';
    }

    // エラーハンドリング
    function handleError(error) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('noResults').style.display = 'block';
      document.getElementById('noResults').innerHTML = `
        <span class="material-icons">error</span>
        <p>データの読み込みに失敗しました</p>
      `;
      console.error(error);
    }

    // HTMLエスケープ
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ハンバーガーメニュー

    // ユーザー名をメニューに表示
  </script>
  <script src="js/nav-menu.js"></script>
</body>
</html>
