<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>年間スケジュール - EQAO PORTAL</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #f8f9fc 0%, #e8ecf4 100%);
      min-height: 100vh;
      padding-bottom: 40px;
    }

    .header {
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 4px 20px rgba(26, 35, 126, 0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .back-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.3s;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    .header-title {
      font-size: 20px;
      font-weight: 700;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    /* カレンダーセクション */
    .calendar-section {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .calendar-nav-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: #f0f0f0;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
    }

    .calendar-nav-btn:hover {
      background: #e0e0e0;
    }

    .calendar-nav-btn .material-icons {
      font-size: 24px;
      color: #333;
    }

    .calendar-month-title {
      font-size: 22px;
      font-weight: 700;
      color: #1a237e;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      background: #e0e0e0;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }

    .calendar-weekday {
      text-align: center;
      font-size: 14px;
      font-weight: 700;
      color: #666;
      padding: 12px 0;
      background: #f5f5f5;
    }

    .calendar-weekday.sun {
      color: #e53935;
    }

    .calendar-weekday.sat {
      color: #1e88e5;
    }

    .calendar-day {
      height: 100px;
      background: white;
      padding: 6px;
      display: flex;
      flex-direction: column;
      cursor: default;
      position: relative;
      overflow: hidden;
    }

    .calendar-day.other-month {
      background: #fafafa;
    }

    .calendar-day.other-month .day-number {
      color: #ccc;
    }

    .day-number {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      text-align: right;
      padding-right: 4px;
      flex-shrink: 0;
    }

    .calendar-day.sun .day-number {
      color: #e53935;
    }

    .calendar-day.sat .day-number {
      color: #1e88e5;
    }

    .calendar-day.today {
      background: #e8eaf6;
    }

    .calendar-day.today .day-number {
      background: #1a237e;
      color: white !important;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 0;
    }

    .day-events {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .day-event {
      font-size: 11px;
      padding: 3px 6px;
      background: #ff5722;
      color: white;
      border-radius: 4px;
      line-height: 1.3;
      word-break: break-all;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      cursor: pointer;
    }

    .day-event:hover {
      opacity: 0.9;
    }

    .day-event-more {
      font-size: 10px;
      color: #666;
      text-align: center;
      flex-shrink: 0;
    }

    /* イベントポップアップ */
    .event-popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      padding: 20px;
    }

    .event-popup-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .event-popup {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.2s;
    }

    .event-popup-overlay.active .event-popup {
      transform: scale(1);
    }

    .event-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .event-popup-date {
      font-size: 16px;
      font-weight: 700;
      color: #1a237e;
    }

    .event-popup-close {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      color: #666;
    }

    .event-popup-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
    }

    .event-popup-detail {
      font-size: 15px;
      color: #666;
      line-height: 1.6;
    }

    /* 月別スケジュールセクション */
    .schedule-section {
      margin-bottom: 24px;
    }

    /* PC: 2カラムレイアウト */
    .schedule-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .month-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      border: 1px solid #e0e0e0;
    }

    .month-header {
      background: #e8eaf6;
      color: #1a237e;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 2px solid #1a237e;
    }

    .month-header .material-icons {
      font-size: 22px;
      color: #1a237e;
    }

    .month-title {
      font-size: 16px;
      font-weight: 700;
    }

    .month-events {
      padding: 8px 0;
    }

    .event-item {
      padding: 14px 20px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      gap: 16px;
    }

    .event-item:last-child {
      border-bottom: none;
    }

    .event-date {
      flex-shrink: 0;
      min-width: 70px;
      font-size: 14px;
      font-weight: 700;
      color: #1a237e;
    }

    .event-date.no-date {
      color: #bbb;
      font-weight: 400;
      font-size: 13px;
    }

    .event-content {
      flex: 1;
    }

    .event-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }

    .event-detail {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
    }

    .no-events {
      padding: 20px;
      text-align: center;
      color: #999;
      font-size: 14px;
    }

    /* ローディング */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e0e0e0;
      border-top-color: #1a237e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* 今日へ戻るボタン */
    .today-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #1a237e;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .today-btn:hover {
      background: #283593;
    }

    .today-btn .material-icons {
      font-size: 18px;
    }

    /* ハンバーガーメニュー */
    .hamburger-btn {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .nav-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .nav-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .nav-menu {
      position: fixed;
      top: 0;
      right: -320px;
      width: 300px;
      height: 100%;
      background: white;
      z-index: 201;
      transition: right 0.3s ease;
      box-shadow: -4px 0 20px rgba(0,0,0,0.15);
      overflow-y: auto;
    }

    .nav-menu.open {
      right: 0;
    }

    .nav-header {
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
      color: white;
      padding: 20px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav-header-title {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .nav-user-section {
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #283593 0%, #3949ab 100%);
    }

    .nav-user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
    }

    .nav-user-info .material-icons {
      font-size: 24px;
      color: rgba(255,255,255,0.7);
    }

    .nav-user-name {
      font-size: 14px;
      font-weight: 500;
    }

    .nav-logout-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 8px;
      color: rgba(255,255,255,0.9);
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
      font-family: inherit;
    }

    .nav-logout-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    .nav-logout-btn .material-icons {
      font-size: 16px;
    }

    .nav-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
    }

    .nav-category {
      font-size: 11px;
      font-weight: 700;
      color: #999;
      padding: 16px 16px 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .nav-section {
      padding: 4px 0;
      border-bottom: 1px solid #eee;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: #333;
      text-decoration: none;
      transition: background 0.2s;
    }

    .nav-item:hover {
      background: #f5f5f5;
    }

    .nav-item .material-icons {
      font-size: 22px;
      color: #1a237e;
    }

    .nav-item span {
      font-size: 14px;
      font-weight: 500;
    }

    .nav-badge {
      background: #ff5722;
      color: white;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: auto;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .nav-badge-wip {
      background: #9e9e9e;
      color: white;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: auto;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* ============================================ */
    /* レスポンシブ対応 */
    /* ============================================ */
    
    /* タブレット */
    @media (max-width: 900px) {
      .container {
        padding: 20px 16px;
      }

      .schedule-grid {
        grid-template-columns: 1fr;
      }

      .calendar-day {
        height: 90px;
      }
    }

    /* スマホ */
    @media (max-width: 600px) {
      .header {
        padding: 12px 16px;
      }

      .header-title {
        font-size: 16px;
      }

      .back-btn {
        width: 36px;
        height: 36px;
      }

      .container {
        padding: 12px 8px;
      }

      .calendar-section {
        padding: 12px;
        border-radius: 12px;
      }

      .calendar-header {
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 8px;
      }

      .calendar-nav {
        gap: 8px;
      }

      .calendar-month-title {
        font-size: 16px;
      }

      .calendar-nav-btn {
        width: 32px;
        height: 32px;
      }

      .calendar-nav-btn .material-icons {
        font-size: 18px;
      }

      .today-btn {
        padding: 5px 10px;
        font-size: 11px;
      }

      .today-btn .material-icons {
        font-size: 14px;
      }

      .calendar-weekday {
        font-size: 10px;
        padding: 6px 0;
      }

      .calendar-day {
        height: 60px;
        padding: 2px;
      }

      .day-number {
        font-size: 11px;
        margin-bottom: 1px;
      }

      .calendar-day.today .day-number {
        width: 20px;
        height: 20px;
        font-size: 10px;
      }

      .day-event {
        font-size: 8px;
        padding: 1px 2px;
        border-radius: 2px;
        -webkit-line-clamp: 1;
      }

      .day-event-more {
        font-size: 8px;
      }

      .month-card {
        border-radius: 12px;
      }

      .month-header {
        padding: 12px 16px;
      }

      .month-header .material-icons {
        font-size: 20px;
      }

      .month-title {
        font-size: 14px;
      }

      .event-item {
        padding: 12px 16px;
        flex-direction: column;
        gap: 6px;
      }

      .event-date {
        font-size: 12px;
        min-width: auto;
      }

      .event-title {
        font-size: 13px;
      }

      .event-detail {
        font-size: 11px;
      }

      .hamburger-btn {
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
      }

      .hamburger-btn .material-icons {
        font-size: 22px;
      }

      .event-popup {
        padding: 16px;
        margin: 16px;
      }

      .event-popup-date {
        font-size: 13px;
      }

      .event-popup-title {
        font-size: 15px;
      }

      .event-popup-detail {
        font-size: 13px;
      }

      .schedule-grid {
        gap: 12px;
      }
    }

    /* さらに小さい画面（iPhone SE等） */
    @media (max-width: 360px) {
      .calendar-day {
        height: 50px;
      }

      .day-number {
        font-size: 10px;
      }

      .calendar-day.today .day-number {
        width: 18px;
        height: 18px;
        font-size: 9px;
      }

      .day-event {
        font-size: 7px;
        padding: 1px;
      }

      .calendar-weekday {
        font-size: 9px;
        padding: 5px 0;
      }

      .calendar-month-title {
        font-size: 14px;
      }

      .calendar-nav-btn {
        width: 28px;
        height: 28px;
      }

      .today-btn {
        padding: 4px 8px;
        font-size: 10px;
      }
    }

    /* 大画面PC */
    @media (min-width: 1400px) {
      .container {
        max-width: 1400px;
      }

      .calendar-day {
        height: 120px;
      }

      .day-event {
        font-size: 12px;
        padding: 4px 8px;
      }

      .schedule-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <a href="index.html" class="back-btn" id="backBtn">
      <span class="material-icons">arrow_back</span>
    </a>
    <h1 class="header-title">年間スケジュール</h1>
  </header>
  
  <!-- ハンバーガーボタン -->
  <button class="hamburger-btn" onclick="openNav()">
    <span class="material-icons">menu</span>
  </button>

  <!-- ナビゲーションオーバーレイ -->
  <div id="navOverlay" class="nav-overlay" onclick="closeNav()"></div>

  <!-- ナビゲーションメニュー -->
  <div id="navMenu" class="nav-menu">
    <div class="nav-header">
      <span class="nav-header-title">メニュー</span>
      <button class="nav-close" onclick="closeNav()">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="nav-user-section">
      <div class="nav-user-info">
        <span class="material-icons">person</span>
        <span id="navUserName" class="nav-user-name"></span>
      </div>
      <button class="nav-logout-btn" onclick="doLogout()">
        <span class="material-icons">logout</span>
        <span>ログアウト</span>
      </button>
    </div>

    <div class="nav-section">
      <a href="index.html" class="nav-item">
        <span class="material-icons">home</span>
        <span>ホーム</span>
      </a>
    </div>

    <div class="nav-category">スケジュール</div>
    <div class="nav-section">
      <a href="yearly-schedule.html" class="nav-item">
        <span class="material-icons">calendar_month</span>
        <span>年間スケジュール</span>
      </a>
      <a href="exam-schedule.html" class="nav-item">
        <span class="material-icons">school</span>
        <span>受験スケジュール</span>
        <span class="nav-badge">個別</span>
      </a>
      <a href="schedule.html" class="nav-item">
        <span class="material-icons">event_note</span>
        <span>授業スケジュール</span>
        <span class="nav-badge">個別</span>
      </a>
    </div>

    <div class="nav-category">学習管理</div>
    <div class="nav-section">
      <a href="checklist.html" class="nav-item">
        <span class="material-icons">checklist</span>
        <span>チェックリスト教材</span>
        <span class="nav-badge">個別</span>
      </a>
    </div>

    <div class="nav-category">コンテンツ</div>
    <div class="nav-section">
      <a href="videos.html" class="nav-item">
        <span class="material-icons">video_library</span>
        <span>過去の集団授業動画</span>
      </a>
      <a href="column.html" class="nav-item">
        <span class="material-icons">article</span>
        <span>コラム一覧</span>
      </a>
    </div>

    <div class="nav-category">面談申し込み</div>
    <div class="nav-section">
      <a href="meeting-principal.html" class="nav-item">
        <span class="material-icons">person</span>
        <span>塾長面談</span>
      </a>
      <a href="meeting-sansya.html" class="nav-item">
        <span class="material-icons">groups</span>
        <span>三者面談</span>
      </a>
      <a href="meeting-tantou.html" class="nav-item">
        <span class="material-icons">support_agent</span>
        <span>担任面談</span>
      </a>
    </div>

    <div class="nav-category">各種申し込み</div>
    <div class="nav-section">
      <a href="forms.html" class="nav-item">
        <span class="material-icons">list_alt</span>
        <span>各種申し込みフォーム一覧</span>
      </a>
    </div>

    <div class="nav-category">カリキュラム</div>
    <div class="nav-section">
      <a href="zoom-links.html" class="nav-item">
        <span class="material-icons">videocam</span>
        <span>Zoomリンク一覧</span>
      </a>
    </div>

    <div class="nav-category">ルール関連</div>
    <div class="nav-section">
      <a href="rules.html" class="nav-item">
        <span class="material-icons">gavel</span>
        <span>生徒/保護者ルール一覧</span>
      </a>
    </div>

    <div class="nav-category">イベント</div>
    <div class="nav-section">
      <a href="mcff.html" class="nav-item">
        <span class="material-icons">mic</span>
        <span>MCFF プレゼン大会</span>
      </a>
    </div>
  </div>


  <div class="container">
    <div id="loadingArea" class="loading">
      <div class="loading-spinner"></div>
      <p>読み込み中...</p>
    </div>

    <div id="contentArea" style="display: none;">
      <!-- カレンダー -->
      <div class="calendar-section">
        <div class="calendar-header">
          <div class="calendar-nav">
            <button class="calendar-nav-btn" onclick="prevMonth()">
              <span class="material-icons">chevron_left</span>
            </button>
            <span id="calendarTitle" class="calendar-month-title"></span>
            <button class="calendar-nav-btn" onclick="nextMonth()">
              <span class="material-icons">chevron_right</span>
            </button>
          </div>
          <button class="today-btn" onclick="goToToday()">
            <span class="material-icons">today</span>
            今日
          </button>
        </div>
        <div id="calendarGrid" class="calendar-grid"></div>
      </div>

      <!-- 月別スケジュール -->
      <div id="scheduleList" class="schedule-section"></div>
    </div>

    <!-- イベントポップアップ -->
    <div id="eventPopup" class="event-popup-overlay" onclick="closePopup(event)">
      <div class="event-popup" onclick="event.stopPropagation()">
        <div class="event-popup-header">
          <span id="popupDate" class="event-popup-date"></span>
          <button class="event-popup-close" onclick="closePopup()">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div id="popupTitle" class="event-popup-title"></div>
        <div id="popupDetail" class="event-popup-detail"></div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // API設定
    // ============================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbyXdCxzPU6oXAm2Mi9mfMDeNvQAyE0mmTOABA2EOYelvX6J2Rr48VcizS0vMgIS7Qc7/exec';

    async function apiGet(action, params = {}) {
      const url = new URL(API_URL);
      url.searchParams.set('action', action);
      for (const [key, value] of Object.entries(params)) {
        if (value !== undefined && value !== null) {
          url.searchParams.set(key, value);
        }
      }
      
      const response = await fetch(url.toString());
      if (!response.ok) {
        throw new Error('API Error: ' + response.status);
      }
      return await response.json();
    }

    let allScheduleData = [];
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth(); // 0-11
    const today = new Date();

    // ページ読み込み時
    document.addEventListener('DOMContentLoaded', function() {
      setNavUserName();
      
      // 戻るボタンのリンク修正
      document.getElementById('backBtn').href = 'index.html?t=' + new Date().getTime();
      
      loadScheduleData();
    });

    // データ読み込み
    async function loadScheduleData() {
      try {
        const data = await apiGet('getYearlySchedule');
        onDataLoaded(data);
      } catch (error) {
        onError(error);
      }
    }

    function onDataLoaded(data) {
      allScheduleData = data || [];
      document.getElementById('loadingArea').style.display = 'none';
      document.getElementById('contentArea').style.display = 'block';
      renderCalendar();
      renderScheduleList();
    }

    function onError(error) {
      console.error(error);
      document.getElementById('loadingArea').innerHTML = 
        '<p style="color: #e53935;">データの読み込みに失敗しました</p>';
    }

    // カレンダー描画
    function renderCalendar() {
      const title = document.getElementById('calendarTitle');
      title.textContent = currentYear + '年' + (currentMonth + 1) + '月';

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';

      // 曜日ヘッダー
      const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
      weekdays.forEach((day, index) => {
        const el = document.createElement('div');
        el.className = 'calendar-weekday';
        if (index === 0) el.classList.add('sun');
        if (index === 6) el.classList.add('sat');
        el.textContent = day;
        grid.appendChild(el);
      });

      // 月の最初の日と最後の日
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      // その月のイベントを取得（年も考慮）
      const eventsForMonth = getEventsForMonth(currentYear, currentMonth + 1);

      // 前月の日
      const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
      for (let i = startDayOfWeek - 1; i >= 0; i--) {
        const el = createDayCell(prevMonthLastDay - i, true, -1, []);
        grid.appendChild(el);
      }

      // 当月の日
      for (let day = 1; day <= daysInMonth; day++) {
        const dayOfWeek = new Date(currentYear, currentMonth, day).getDay();
        const isToday = currentYear === today.getFullYear() && 
                        currentMonth === today.getMonth() && 
                        day === today.getDate();
        const dayEvents = eventsForMonth[day] || [];
        const el = createDayCell(day, false, dayOfWeek, dayEvents, isToday);
        grid.appendChild(el);
      }

      // 次月の日（6行になるように）
      const totalCells = startDayOfWeek + daysInMonth;
      const remainingCells = (7 - (totalCells % 7)) % 7;
      for (let i = 1; i <= remainingCells; i++) {
        const el = createDayCell(i, true, -1, []);
        grid.appendChild(el);
      }
    }

    // 日付セルを作成
    function createDayCell(day, isOtherMonth, dayOfWeek, events, isToday) {
      const el = document.createElement('div');
      el.className = 'calendar-day';
      
      if (isOtherMonth) {
        el.classList.add('other-month');
      } else {
        if (dayOfWeek === 0) el.classList.add('sun');
        if (dayOfWeek === 6) el.classList.add('sat');
        if (isToday) el.classList.add('today');
      }

      // 日付
      const numberEl = document.createElement('div');
      numberEl.className = 'day-number';
      numberEl.textContent = day;
      el.appendChild(numberEl);

      // イベント
      if (!isOtherMonth && events.length > 0) {
        const eventsEl = document.createElement('div');
        eventsEl.className = 'day-events';
        
        // 画面幅に応じて表示件数を調整
        let maxShow = 2;
        if (window.innerWidth <= 480) {
          maxShow = 1;
        } else if (window.innerWidth >= 1400) {
          maxShow = 3;
        }
        
        events.slice(0, maxShow).forEach(event => {
          const eventEl = document.createElement('div');
          eventEl.className = 'day-event';
          eventEl.textContent = event.title;
          eventEl.onclick = function(e) {
            e.stopPropagation();
            showPopup(day, event);
          };
          eventsEl.appendChild(eventEl);
        });

        // 残りがある場合
        if (events.length > maxShow) {
          const moreEl = document.createElement('div');
          moreEl.className = 'day-event-more';
          moreEl.textContent = '+' + (events.length - maxShow) + '件';
          eventsEl.appendChild(moreEl);
        }

        el.appendChild(eventsEl);
      }

      return el;
    }

    // その月のイベントを日付ごとに取得（年も考慮）
    function getEventsForMonth(year, month) {
      const eventsByDay = {};
      allScheduleData.forEach(item => {
        if (item.year === year && item.month === month && item.day) {
          if (!eventsByDay[item.day]) {
            eventsByDay[item.day] = [];
          }
          eventsByDay[item.day].push(item);
        }
      });
      return eventsByDay;
    }

    // ポップアップ表示
    function showPopup(day, event) {
      document.getElementById('popupDate').textContent = (currentMonth + 1) + '月' + day + '日';
      document.getElementById('popupTitle').textContent = event.title;
      document.getElementById('popupDetail').textContent = event.detail || '';
      document.getElementById('eventPopup').classList.add('active');
    }

    // ポップアップを閉じる
    function closePopup(e) {
      if (!e || e.target.id === 'eventPopup') {
        document.getElementById('eventPopup').classList.remove('active');
      }
    }

    // 月別スケジュール一覧描画
    function renderScheduleList() {
      const container = document.getElementById('scheduleList');
      container.innerHTML = '';

      // グリッドコンテナを作成
      const grid = document.createElement('div');
      grid.className = 'schedule-grid';

      // 現在表示中の年月から12ヶ月分を表示
      for (let i = 0; i < 12; i++) {
        let displayMonth = currentMonth + i;
        let displayYear = currentYear;
        
        if (displayMonth > 11) {
          displayMonth -= 12;
          displayYear += 1;
        }
        
        const monthNum = displayMonth + 1; // 1-12

        // その月のイベントを取得（年は関係なく、月だけで判定）
        const events = allScheduleData.filter(item => item.month === monthNum);

        // 同じタイトルをまとめる
        const groupedEvents = {};
        events.forEach(event => {
          const key = event.title;
          if (!groupedEvents[key]) {
            groupedEvents[key] = {
              title: event.title,
              detail: event.detail,
              days: []
            };
          }
          if (event.day) {
            groupedEvents[key].days.push(event.day);
          }
        });

        // 配列に変換してソート
        const mergedEvents = Object.values(groupedEvents);
        mergedEvents.forEach(e => {
          e.days = [...new Set(e.days)].sort((a, b) => a - b); // 重複除去＆ソート
        });
        // 最初の日付でソート（日付なしは最後）
        mergedEvents.sort((a, b) => {
          if (a.days.length === 0 && b.days.length === 0) return 0;
          if (a.days.length === 0) return 1;
          if (b.days.length === 0) return -1;
          return a.days[0] - b.days[0];
        });

        const card = document.createElement('div');
        card.className = 'month-card';

        // 月ヘッダー
        const header = document.createElement('div');
        header.className = 'month-header';
        header.innerHTML = '<span class="material-icons">event</span><span class="month-title">' + monthNum + '月</span>';
        card.appendChild(header);

        // イベント一覧
        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'month-events';

        if (mergedEvents.length === 0) {
          // 予定がない場合
          const noEvents = document.createElement('div');
          noEvents.className = 'no-events';
          noEvents.textContent = '予定はありません';
          eventsContainer.appendChild(noEvents);
        } else {
          mergedEvents.forEach(event => {
            const item = document.createElement('div');
            item.className = 'event-item';

            const dateEl = document.createElement('div');
            dateEl.className = 'event-date';
            if (event.days.length > 0) {
              dateEl.textContent = event.days.join(',') + '日';
            } else {
              dateEl.textContent = 'ー';
              dateEl.classList.add('no-date');
            }

            const contentEl = document.createElement('div');
            contentEl.className = 'event-content';

            const titleEl = document.createElement('div');
            titleEl.className = 'event-title';
            titleEl.textContent = event.title;
            contentEl.appendChild(titleEl);

            if (event.detail) {
              const detailEl = document.createElement('div');
              detailEl.className = 'event-detail';
              detailEl.textContent = event.detail;
              contentEl.appendChild(detailEl);
            }

            item.appendChild(dateEl);
            item.appendChild(contentEl);
            eventsContainer.appendChild(item);
          });
        }

        card.appendChild(eventsContainer);
        grid.appendChild(card);
      }

      container.appendChild(grid);
    }

    // 前月
    function prevMonth() {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
    }

    // 次月
    function nextMonth() {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    }

    // 今日へ戻る
    function goToToday() {
      currentYear = today.getFullYear();
      currentMonth = today.getMonth();
      renderCalendar();
    }
  
    // ハンバーガーメニュー
    function openNav() {
      document.getElementById('navMenu').classList.add('open');
      document.getElementById('navOverlay').classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeNav() {
      document.getElementById('navMenu').classList.remove('open');
      document.getElementById('navOverlay').classList.remove('open');
      document.body.style.overflow = '';
    }

    function doLogout() {
      localStorage.removeItem('eqao_loggedIn');
      localStorage.removeItem('eqao_studentId');
      localStorage.removeItem('eqao_studentName');
      localStorage.removeItem('eqao_password');
      localStorage.removeItem('eqao_rowIndex');
      localStorage.removeItem('eqao_isAdmin');
      window.location.href = 'index.html';
    }

    function setNavUserName() {
      const studentName = localStorage.getItem('eqao_studentName');
      const navUserName = document.getElementById('navUserName');
      if (navUserName) {
        navUserName.textContent = studentName || '';
      }
    }

    // ウィンドウリサイズ時にカレンダーを再描画
    let resizeTimer;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(function() {
        renderCalendar();
      }, 250);
    });
  </script>
</body>
</html>
